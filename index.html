<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quizzer - Fun Educational Quizzes</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        primary: '#3A9F35', // Jungle green primary color
        secondary: '#F8B620', // Warm yellow/orange for accent
        red: '#e21b3c',
        blue: '#1368ce',
        yellow: '#F8B620',
        green: '#3A9F35',
        brown: '#7B5429', // Earthy brown for jungle theme
        leafgreen: '#6BB45C', // Light leaf green
        sand: '#F3D19E', // Sandy color
        purple: '#8A2BE2',
        orange: '#FF8C00',
      },
      animation: {
        'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
        'bounce-slow': 'bounce 3s infinite',
        'fade-in': 'fadeIn 0.5s ease-in-out',
        'fade-in-up': 'fadeInUp 0.5s ease-out',
        'slide-in': 'slideIn 0.4s ease-out',
        'move-right': 'moveRight 10s linear infinite',
        'float-up': 'floatUp 3s ease-in-out infinite alternate',
        'shake': 'shake 0.5s ease-in-out',
        'coin-spin': 'coinSpin 1s ease-in-out',
        'grow': 'grow 0.4s ease-out',
        'rotate': 'rotate 10s linear infinite',
        'logo-bounce': 'logoBounce 2s ease-in-out infinite alternate',
      },
      keyframes: {
        fadeIn: {
          '0%': { opacity: '0' },
          '100%': { opacity: '1' },
        },
        fadeInUp: {
          '0%': {
            opacity: '0',
            transform: 'translateY(10px)'
          },
          '100%': {
            opacity: '1',
            transform: 'translateY(0)'
          },
        },
        slideIn: {
          '0%': { transform: 'translateX(-20px)', opacity: '0' },
          '100%': { transform: 'translateX(0)', opacity: '1' },
        },
        moveRight: {
          '0%': { transform: 'translateX(-100%)' },
          '100%': { transform: 'translateX(100%)' }
        },
        floatUp: {
          '0%': { transform: 'translateY(0)' },
          '100%': { transform: 'translateY(-20px)' }
        },
        shake: {
          '0%, 100%': { transform: 'translateX(0)' },
          '25%': { transform: 'translateX(-5px)' },
          '75%': { transform: 'translateX(5px)' }
        },
        coinSpin: {
          '0%': { transform: 'rotateY(0)' },
          '50%': { transform: 'rotateY(180deg)' },
          '100%': { transform: 'rotateY(360deg)' }
        },
        grow: {
          '0%': { transform: 'scale(0)' },
          '100%': { transform: 'scale(1)' }
        },
        rotate: {
          '0%': { transform: 'rotate(0deg)' },
          '100%': { transform: 'rotate(360deg)' }
        },
        logoBounce: {
          '0%': { transform: 'translateY(0)' },
          '100%': { transform: 'translateY(-10px)' }
        }
      }
    }
  }
}
</script>
<style>
/* Background styles */
.bg-pattern-light {
  background-color: #ffffff;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3E%3Cg fill-rule='evenodd'%3E%3Cg fill='%233A9F35' fill-opacity='0.1'%3E%3Cpath d='M0 0h40v40H0V0zm40 40h40v40H40V40zm0-40h2l-2 2V0zm0 4l4-4h2l-6 6V4zm0 4l8-8h2L40 10V8zm0 4L52 0h2L40 14v-2zm0 4L56 0h2L40 18v-2zm0 4L60 0h2L40 22v-2zm0 4L64 0h2L40 26v-2zm0 4L68 0h2L40 30v-2zm0 4L72 0h2L40 34v-2zm0 4L76 0h2L40 38v-2zm0 4L80 0v2L42 40h-2zm4 0L80 4v2L46 40h-2zm4 0L80 8v2L50 40h-2zm4 0l28-28v2L54 40h-2zm4 0l24-24v2L58 40h-2zm4 0l20-20v2L62 40h-2zm4 0l16-16v2L66 40h-2zm4 0l12-12v2L70 40h-2zm4 0l8-8v2l-6 6h-2zm4 0l4-4v2l-2 2h-2z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
}

/* Game mode specific backgrounds */
.bg-standard-mode-light {
  background-color: #ffffff;
  background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%233A9F35' fill-opacity='0.1' fill-rule='evenodd'%3E%3Ccircle cx='3' cy='3' r='3'/%3E%3Ccircle cx='13' cy='13' r='3'/%3E%3C/g%3E%3C/svg%3E");
}

.bg-boss-fight-light {
  background-color: #ffe8e8;
  background-image: url("data:image/svg+xml,%3Csvg width='52' height='26' viewBox='0 0 52 26' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23e21b3c' fill-opacity='0.1'%3E%3Cpath d='M10 10c0-2.21-1.79-4-4-4-3.314 0-6-2.686-6-6h2c0 2.21 1.79 4 4 4 3.314 0 6 2.686 6 6 0 2.21 1.79 4 4 4 3.314 0 6 2.686 6 6 0 2.21 1.79 4 4 4v2c-3.314 0-6-2.686-6-6 0-2.21-1.79-4-4-4-3.314 0-6-2.686-6-6zm25.464-1.95l8.486 8.486-1.414 1.414-8.486-8.486 1.414-1.414z' /%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
}

.bg-sudden-death-light {
  background-color: #ffedf2;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='28' height='49' viewBox='0 0 28 49'%3E%3Cg fill-rule='evenodd'%3E%3Cg id='hexagons' fill='%23e21b3c' fill-opacity='0.1' fill-rule='nonzero'%3E%3Cpath d='M13.99 9.25l13 7.5v15l-13 7.5L1 31.75v-15l12.99-7.5zM3 17.9v12.7l10.99 6.34 11-6.35V17.9l-11-6.34L3 17.9zM0 15l12.98-7.5V0h-2v6.35L0 12.69v2.3zm0 18.5L12.98 41v8h-2v-6.85L0 35.81v-2.3zM15 0v7.5L27.99 15H28v-2.31h-.01L17 6.35V0h-2zm0 49v-8l12.99-7.5H28v2.31h-.01L17 42.15V49h-2z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
}

.bg-team-battle-light {
  background-color: #fff8e8;
  background-image: url("data:image/svg+xml,%3Csvg width='100' height='20' viewBox='0 0 100 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M21.184 20c.357-.13.72-.264.088-.402l1.768-4.383c.13.003.262.006.393.006.61 0 1.206-.044 1.778-.12l.004.16 2.144 4.39.15.3c.712-.18 1.373-.514 1.947-1.019.35-.327.636-.72.9-1.142l-2.53-1.96A2.5 2.5 0 0 1 26.4 8.879a2.5 2.5 0 0 1 4.93.393l2.317 2.033c.262-.544.428-1.098.428-1.707C34.073 6.2 31.06 3.6 27.36 3.6c-3.702 0-6.717 2.6-6.717 5.598 0 .603.13 1.177.358 1.738l-2.358 1.647A18.28 18.28 0 0 1 20.002 7c0-4.091-5.192-7-11.6-7-6.408 0-11.6 2.909-11.6 7s5.192 7 11.6 7c1.53 0 2.99-.172 4.313-.476 1.272-.29 2.437-.722 3.44-1.261L18.8 16.518c.192.38.427.544.772.62L21.184 20z' fill='%23FF8C00' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
}

/* Jungle themed elements */
.leaf {
  position: absolute;
  pointer-events: none;
  animation: float-leaf linear infinite, sway 3s ease-in-out infinite alternate;
  z-index: 1;
  opacity: 0.7;
}

@keyframes float-leaf {
  0% {
    transform: translateY(0) rotate(0deg);
  }
  100% {
    transform: translateY(-100vh) rotate(360deg);
  }
}

@keyframes sway {
  0% { margin-left: 0; }
  100% { margin-left: 50px; }
}

/* Floating shape animations */
.floating-shapes {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 0;
  overflow: hidden;
}

.shape {
  position: absolute;
  opacity: 0.12;
  border-radius: 50%;
  animation: float linear infinite;
}

@keyframes float {
  0% {
    transform: translateY(0) rotate(0deg);
  }
  100% {
    transform: translateY(-100vh) rotate(360deg);
  }
}

/* Timer styles */
@keyframes countdown {
  from { width: 100%; }
  to { width: 0%; }
}

.timer-animation {
  animation: countdown linear forwards;
}

.answer-card {
  transition: all 0.2s ease-in-out;
  transform-origin: center;
}

.answer-card:active {
  transform: scale(0.97);
}

.answer-card:hover {
  filter: brightness(1.05);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.pulse-animation {
  animation: pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* Card styles for better readability over the background */
.content-card {
  backdrop-filter: blur(3px);
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

/* Sound controls */
.sound-control {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 50;
  background-color: rgba(255, 255, 255, 0.8);
  color: #333;
  border-radius: 50%;
  width: 60px;
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
  transition: all 0.2s ease;
}

.sound-control:hover {
  transform: scale(1.1);
}

/* Avatar styles */
.avatar {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background-size: cover;
  background-position: center;
  border: 2px solid white;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  position: relative;
}

.avatar-option {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
}

.avatar-option:hover {
  transform: scale(1.1);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.avatar-option.selected {
  border: 3px solid #3A9F35;
  box-shadow: 0 0 0 3px rgba(58, 159, 53, 0.3);
}

.avatar-option.locked {
  opacity: 0.5;
  position: relative;
  overflow: hidden;
  cursor: not-allowed;
}

.avatar-option.locked::before {
  content: "🔒";
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.4);
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  font-size: 1.2rem;
}

/* Accessory display */
.accessory {
  position: absolute;
  font-size: 1.2rem;
  z-index: 10;
}

.accessory-crown {
  top: -15px;
  left: 50%;
  transform: translateX(-50%);
}

.accessory-glasses {
  top: 5px;
  left: 50%;
  transform: translateX(-50%);
}

.accessory-hat {
  top: -15px;
  left: 50%;
  transform: translateX(-50%);
}

.accessory-bowtie {
  bottom: -5px;
  left: 50%;
  transform: translateX(-50%);
}

.accessory-necktie {
  bottom: -12px;
  left: 50%;
  transform: translateX(-50%);
}

.accessory-headphones {
  top: -5px;
  left: 50%;
  transform: translateX(-50%);
}

.accessory-diploma {
  top: -15px;
  right: -5px;
}

.accessory-option {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: white;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  margin: 0 5px;
}

.accessory-option:hover {
  transform: scale(1.1);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.accessory-option.selected {
  border: 2px solid #3A9F35;
  box-shadow: 0 0 0 2px rgba(58, 159, 53, 0.3);
}

.accessory-option.locked {
  opacity: 0.5;
  position: relative;
  overflow: hidden;
  cursor: not-allowed;
}

.accessory-option.locked::before {
  content: "🔒";
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.4);
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  font-size: 1rem;
}

/* Card hover effects */
.action-card {
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.action-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 15px 30px -10px rgba(0, 0, 0, 0.2);
}

/* Quiz creator styles */
.question-card {
  position: relative;
  transition: all 0.3s ease;
}

.question-card:hover .question-actions {
  opacity: 1;
}

.question-actions {
  opacity: 0;
  transition: opacity 0.2s ease;
}

.correct-answer {
  border-left: 4px solid #3A9F35;
}

/* Badge styles */
.badge {
  background-color: #f8f9fa;
  border-radius: 9999px;
  padding: 0.25rem 0.75rem;
  font-size: 0.875rem;
  font-weight: 500;
  display: inline-flex;
  align-items: center;
  box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  transition: all 0.3s ease;
}

.badge:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.badge i {
  margin-right: 0.25rem;
}

/* Tooltip */
.tooltip {
  position: relative;
  display: inline-block;
}

.tooltip .tooltip-text {
  visibility: hidden;
  background-color: rgba(0, 0, 0, 0.8);
  color: #fff;
  text-align: center;
  border-radius: 6px;
  padding: 5px 10px;
  position: absolute;
  z-index: 1;
  bottom: 125%;
  left: 50%;
  transform: translateX(-50%);
  opacity: 0;
  transition: opacity 0.3s;
  white-space: nowrap;
  font-size: 0.75rem;
}

.tooltip:hover .tooltip-text {
  visibility: visible;
  opacity: 1;
}

/* Countdown animation */
.countdown-number {
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 6rem;
  font-weight: bold;
  animation: countdownAnimation 1s ease-in-out;
}

@keyframes countdownAnimation {
  0% {
    transform: scale(2);
    opacity: 0;
  }
  20% {
    transform: scale(1.5);
    opacity: 1;
  }
  80% {
    transform: scale(1);
    opacity: 1;
  }
  100% {
    transform: scale(0.5);
    opacity: 0;
  }
}

/* Hint system */
.hint-badge {
  position: absolute;
  top: 10px;
  right: 10px;
  background: rgba(58, 159, 53, 0.1);
  border: 1px solid rgba(58, 159, 53, 0.3);
  color: #3A9F35;
  border-radius: 20px;
  padding: 4px 12px;
  font-size: 0.75rem;
  cursor: pointer;
  transition: all 0.2s ease;
}

.hint-badge:hover {
  background: rgba(58, 159, 53, 0.2);
}

.hint-content {
  display: none;
  margin-top: 10px;
  padding: 10px;
  background: rgba(248, 182, 32, 0.1);
  border: 1px solid rgba(248, 182, 32, 0.3);
  border-radius: 8px;
  font-style: italic;
}

/* Share results styles */
.share-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  border-radius: 9999px;
  font-weight: 500;
  transition: all 0.2s ease;
}

.share-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

/* Achievement styles */
.achievement {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem;
  border-radius: 0.5rem;
  background: rgba(255,255,255,0.5);
  margin-bottom: 0.5rem;
  transition: all 0.2s ease;
}

.achievement:hover {
  transform: translateX(5px);
}

.achievement-icon {
  width: 2.5rem;
  height: 2.5rem;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  font-size: 1.25rem;
}

.achievement-locked {
  opacity: 0.5;
  filter: grayscale(1);
}

/* Responsive improvements */
@media (max-width: 640px) {
  .answer-card {
    height: auto;
    min-height: 60px;
    padding: 12px 16px;
    font-size: 0.95rem;
  }

  .avatar-option {
    width: 45px;
    height: 45px;
    font-size: 1.5rem;
  }

  .countdown-number {
    font-size: 4rem;
  }
}

@media (max-width: 360px) {
  .content-card {
    padding: 12px;
  }

  .avatar-option {
    width: 35px;
    height: 35px;
    font-size: 1.2rem;
  }

  .countdown-number {
    font-size: 3rem;
  }
}

/* Boss Fight Mode Styles */
.boss-container {
  position: relative;
  height: 160px;
  width: 100%;
  background: rgba(0,0,0,0.2);
  border-radius: 10px;
  overflow: hidden;
  margin-bottom: 20px;
}

.boss {
  position: absolute;
  top: 50%;
  right: 10%;
  transform: translateY(-50%);
  font-size: 4rem;
  transition: all 0.3s ease;
}

.boss-health-container {
  position: absolute;
  top: 10px;
  left: 10px;
  right: 10px;
  height: 14px;
  background: rgba(0,0,0,0.3);
  border-radius: 7px;
  overflow: hidden;
}

.boss-health {
  height: 100%;
  background: linear-gradient(90deg, #e21b3c, #ff5757);
  width: 100%;
  transition: width 0.5s ease;
}

.boss-name {
  position: absolute;
  top: 30px;
  left: 10px;
  color: white;
  font-weight: bold;
  text-shadow: 0 0 3px rgba(0,0,0,0.5);
}

.boss-attack {
  position: absolute;
  opacity: 0;
  font-size: 2rem;
  animation: bossAttack 1s forwards;
}

@keyframes bossAttack {
  0% {
    opacity: 0;
    transform: translateY(0) scale(0.5);
  }
  50% {
    opacity: 1;
    transform: translateY(-20px) scale(1);
  }
  100% {
    opacity: 0;
    transform: translateY(-40px) scale(0.8);
  }
}

.player-damage {
  position: absolute;
  color: red;
  font-weight: bold;
  font-size: 1.25rem;
  animation: damageAnimation 1s forwards;
}

@keyframes damageAnimation {
  0% {
    opacity: 0;
    transform: translateY(0);
  }
  10% {
    opacity: 1;
  }
  100% {
    opacity: 0;
    transform: translateY(-30px);
  }
}

.boss-hit {
  animation: bossHit 0.3s;
}

@keyframes bossHit {
  0%, 100% {
    transform: translateY(-50%);
  }
  50% {
    transform: translateY(-50%) scale(1.1);
  }
}

.boss-defeated {
  animation: bossDefeated 2s forwards;
}

@keyframes bossDefeated {
  0% {
    transform: translateY(-50%);
    opacity: 1;
  }
  20% {
    transform: translateY(-50%) scale(1.2);
    opacity: 1;
  }
  100% {
    transform: translateY(-50%) scale(0);
    opacity: 0;
  }
}

/* Shop styles */
.shop-item {
  display: flex;
  align-items: center;
  padding: 0.75rem;
  border-radius: 0.5rem;
  background: rgba(255,255,255,0.5);
  margin-bottom: 0.5rem;
  transition: all 0.2s ease;
  border: 2px solid transparent;
}

.shop-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.shop-item.selected {
  border-color: #3A9F35;
}

.shop-item-icon {
  width: 2.5rem;
  height: 2.5rem;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  font-size: 1.5rem;
  margin-right: 0.75rem;
  background: white;
}

.shop-item-details {
  flex: 1;
}

.shop-item-price {
  display: flex;
  align-items: center;
  font-weight: bold;
  color: #F8B620;
}

.coin-icon {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 20px;
  height: 20px;
  background-color: #F8B620;
  border-radius: 50%;
  color: white;
  font-weight: bold;
  margin-right: 3px;
  font-size: 0.7rem;
}

/* Coin balance display */
.coin-balance {
  display: flex;
  align-items: center;
  font-weight: bold;
  padding: 0.5rem 0.75rem;
  background: rgba(248, 182, 32, 0.1);
  border-radius: 9999px;
  color: #F8B620;
}

.coin-animation {
  animation: coinJump 0.5s ease;
}

@keyframes coinJump {
  0%, 100% {
    transform: translateY(0);
  }
  50% {
    transform: translateY(-10px);
  }
}

/* Game mode card highlighting */
.game-mode-card {
  cursor: pointer;
  border: 2px solid transparent;
  transition: all 0.3s ease;
}

.game-mode-card.selected {
  border-color: #3A9F35;
  background-color: rgba(58, 159, 53, 0.1);
}

.game-mode-card:hover:not(.selected) {
  border-color: rgba(58, 159, 53, 0.3);
}

/* Logo Styles */
.logo-container {
  position: relative;
  width: 120px;
  height: 120px;
  margin: 0 auto;
  perspective: 1000px;
}

.logo {
  width: 100%;
  height: 100%;
  position: relative;
  transform-style: preserve-3d;
  animation: logo-bounce 3s ease-in-out infinite alternate;
}

.logo-circle {
  position: absolute;
  width: 100%;
  height: 100%;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 6px 12px rgba(0,0,0,0.2);
  background: linear-gradient(135deg, #3A9F35, #6BB45C);
}

.logo-letter {
  font-size: 60px;
  font-weight: bold;
  color: white;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.logo-orbit {
  position: absolute;
  top: -5px;
  left: -5px;
  right: -5px;
  bottom: -5px;
  border: 2px dashed rgba(255,255,255,0.5);
  border-radius: 50%;
  animation: rotate 15s linear infinite;
}

.logo-planet {
  position: absolute;
  width: 30px;
  height: 30px;
  border-radius: 50%;
  background: #F8B620;
  top: 0;
  left: 50%;
  transform: translateX(-50%);
  box-shadow: 0 3px 6px rgba(0,0,0,0.2);
}

/* Sudden Death Mode Styles */
.sudden-death-indicator {
  position: absolute;
  bottom: 10px;
  right: 10px;
  background: rgba(0, 0, 0, 0.1);
  border: 1px solid rgba(0, 0, 0, 0.3);
  color: #000;
  border-radius: 20px;
  padding: 4px 12px;
  font-size: 0.75rem;
  font-weight: bold;
}

.heart-container {
  display: flex;
  gap: 5px;
}

.heart {
  color: #e21b3c;
  font-size: 1rem;
}

@keyframes heartbeat {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.2); }
}

.beating-heart {
  animation: heartbeat 1s ease-in-out infinite;
}

/* Team Battle Mode Styles */
.vs-container {
  position: relative;
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.player-side, .ai-side {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
}

.vs-badge {
  width: 40px;
  height: 40px;
  background: #F8B620;
  color: white;
  font-weight: bold;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 3px 6px rgba(0,0,0,0.2);
}

.player-avatar, .ai-avatar {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2rem;
  background: rgba(255,255,255,0.2);
  border: 3px solid white;
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  position: relative;
}

.player-score, .ai-score {
  font-weight: bold;
  font-size: 1.2rem;
}

/* Streak indicator */
.streak-indicator {
  position: absolute;
  top: 10px;
  left: 10px;
  background: rgba(248, 182, 32, 0.1);
  border: 1px solid rgba(248, 182, 32, 0.3);
  color: #F8B620;
  border-radius: 20px;
  padding: 4px 12px;
  font-size: 0.75rem;
  font-weight: bold;
  display: flex;
  align-items: center;
  gap: 5px;
}

.streak-fire {
  font-size: 1rem;
}

@keyframes flicker {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

.flickering {
  animation: flicker 0.6s ease-in-out infinite;
}

/* Hint button styles */
.hint-button {
  padding: 8px 16px;
  background-color: rgba(58, 159, 53, 0.2);
  color: #3A9F35;
  border: 1px solid rgba(58, 159, 53, 0.4);
  border-radius: 20px;
  font-size: 0.9rem;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.2s ease;
  display: inline-flex;
  align-items: center;
  margin-bottom: 15px;
}

.hint-button:hover {
  background-color: rgba(58, 159, 53, 0.3);
}

.hint-button i {
  margin-right: 6px;
}

/* User avatar display in boss fight */
.player-health-info {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
}

.player-health-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  background: rgba(255,255,255,0.2);
  border: 2px solid white;
  box-shadow: 0 2px 4px rgba(0,0,0,0.15);
  position: relative;
}

.player-health-details {
  flex: 1;
}

/* Music Animation */
@keyframes musicPulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(0.95); }
}

.music-playing {
  animation: musicPulse 1s ease-in-out infinite;
  color: #F8B620;
}

/* Tabs for shop */
.shop-tab {
  padding: 8px 16px;
  border-radius: 8px 8px 0 0;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.2s ease;
}

.shop-tab.active {
  background-color: white;
  box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
}

.shop-tab:not(.active) {
  background-color: rgba(255,255,255,0.5);
  box-shadow: 0 -1px 2px rgba(0,0,0,0.05);
}

/* Achievement reward animation */
@keyframes rewardPulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

.reward-pulse {
  animation: rewardPulse 1s ease-in-out 2;
  color: #F8B620;
}

/* Share quiz styles */
.share-link-container {
  background: rgba(19, 104, 206, 0.1);
  border: 1px solid rgba(19, 104, 206, 0.3);
  border-radius: 8px;
  padding: 12px;
  margin-top: 16px;
}

.share-link-input {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 14px;
  margin-bottom: 8px;
}

.share-actions {
  display: flex;
  justify-content: space-between;
}

.share-text {
  font-size: 14px;
  color: #666;
  margin-bottom: 8px;
}
</style>
</head>
<body>
<div id="app-container" class="bg-pattern-light min-h-screen font-sans text-gray-900 relative">
<!-- Initial content will be added here by JavaScript -->
</div>

<!-- Sound control button -->
<div id="sound-control" class="sound-control">
<span id="sound-icon" class="text-2xl">🔇</span>
</div>

<!-- Countdown overlay -->
<div id="countdown-overlay" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
<div id="countdown-display" class="countdown-number text-white"></div>
</div>

<!-- Audio elements for background music -->
<audio id="menu-music" loop preload="none">
  <source src="https://cdn.jsdelivr.net/gh/rafaelcastrocouto/dotacard@gh-pages/sounds/music/laning1.ogg" type="audio/ogg">
</audio>

<audio id="standard-music" loop preload="none">
  <source src="https://cdn.jsdelivr.net/gh/rafaelcastrocouto/dotacard@gh-pages/sounds/music/laning2.ogg" type="audio/ogg">
</audio>

<audio id="boss-music" loop preload="none">
  <source src="https://cdn.jsdelivr.net/gh/rafaelcastrocouto/dotacard@gh-pages/sounds/music/battle1.ogg" type="audio/ogg">
</audio>

<audio id="sudden-death-music" loop preload="none">
  <source src="https://cdn.jsdelivr.net/gh/rafaelcastrocouto/dotacard@gh-pages/sounds/music/battle2.ogg" type="audio/ogg">
</audio>

<audio id="team-battle-music" loop preload="none">
  <source src="https://cdn.jsdelivr.net/gh/rafaelcastrocouto/dotacard@gh-pages/sounds/music/battle3.ogg" type="audio/ogg">
</audio>

<script>
// In-memory storage for when localStorage is unavailable
const memoryStorage = {
  data: {},
  getItem(key) {
    return this.data[key] || null;
  },
  setItem(key, value) {
    this.data[key] = value;
  },
  removeItem(key) {
    delete this.data[key];
  },
  clear() {
    this.data = {};
  }
};

// Storage helper that tries localStorage first, but falls back to memory storage
const safeStorage = {
  getItem(key) {
    try {
      if (typeof localStorage !== 'undefined') {
        return localStorage.getItem(key);
      }
    } catch (e) {
      console.log("localStorage not available, using memory storage");
    }
    return memoryStorage.getItem(key);
  },
  setItem(key, value) {
    try {
      if (typeof localStorage !== 'undefined') {
        localStorage.setItem(key, value);
        return;
      }
    } catch (e) {
      console.log("localStorage not available, using memory storage");
    }
    memoryStorage.setItem(key, value);
  },
  removeItem(key) {
    try {
      if (typeof localStorage !== 'undefined') {
        localStorage.removeItem(key);
        return;
      }
    } catch (e) {
      console.log("localStorage not available, using memory storage");
    }
    memoryStorage.removeItem(key);
  },
  clear() {
    try {
      if (typeof localStorage !== 'undefined') {
        localStorage.clear();
        return;
      }
    } catch (e) {
      console.log("localStorage not available, using memory storage");
    }
    memoryStorage.clear();
  }
};

// Basic avatars (free)
const basicAvatars = [
  { id: 'lion', emoji: '🦁', name: 'Lion', price: 0 },
  { id: 'monkey', emoji: '🐵', name: 'Monkey', price: 0 },
  { id: 'elephant', emoji: '🐘', name: 'Elephant', price: 0 },
  { id: 'tiger', emoji: '🐯', name: 'Tiger', price: 0 },
  { id: 'panda', emoji: '🐼', name: 'Panda', price: 0 }
];

// Premium avatars (purchasable) - limited to 7
const premiumAvatars = [
  { id: 'koala', emoji: '🐨', name: 'Koala', price: 50 },
  { id: 'fox', emoji: '🦊', name: 'Fox', price: 75 },
  { id: 'owl', emoji: '🦉', name: 'Owl', price: 100 },
  { id: 'penguin', emoji: '🐧', name: 'Penguin', price: 150 },
  { id: 'dragon', emoji: '🐉', name: 'Dragon', price: 250 },
  { id: 'unicorn', emoji: '🦄', name: 'Unicorn', price: 350 },
  { id: 'robot', emoji: '🤖', name: 'Robot', price: 500 }
];

// Accessories system
const accessories = [
  { id: 'crown', emoji: '👑', name: 'Crown', price: 100 },
  { id: 'glasses', emoji: '👓', name: 'Glasses', price: 75 },
  { id: 'hat', emoji: '🎩', name: 'Top Hat', price: 125 },
  { id: 'bowtie', emoji: '🎀', name: 'Bow Tie', price: 100 },
  { id: 'necktie', emoji: '👔', name: 'Necktie', price: 125 },
  { id: 'headphones', emoji: '🎧', name: 'Headphones', price: 150 },
  { id: 'diploma', emoji: '🎓', name: 'Graduation Cap', price: 200 }
];

// Combined avatars (both basic and premium)
const avatars = [...basicAvatars, ...premiumAvatars];

// AI player names and avatars
const aiPlayers = [
// Science category
{name: "ScienceGeek", avatar: "🔬", category: "Science"},
{name: "LabCoat", avatar: "⚗️", category: "Science"},
{name: "EinsteinFan", avatar: "💡", category: "Science"},
{name: "PhysicsPhenom", avatar: "⚛️", category: "Science"},
{name: "BioBrain", avatar: "🧬", category: "Science"},
{name: "ChemistryChamp", avatar: "💊", category: "Science"},
{name: "QuantumQuiz", avatar: "🔭", category: "Science"},

// History category
{name: "HistoryBuff", avatar: "📜", category: "History"},
{name: "TimeTraveler", avatar: "⏳", category: "History"},
{name: "AncientExplorer", avatar: "🏺", category: "History"},
{name: "PastMaster", avatar: "🏛️", category: "History"},
{name: "ChronicleChamp", avatar: "📚", category: "History"},
{name: "ArchaeologyAce", avatar: "🔎", category: "History"},
{name: "EraExpert", avatar: "🗿", category: "History"},

// Entertainment category
{name: "MovieManiac", avatar: "🎬", category: "Entertainment"},
{name: "CelebSleuth", avatar: "🔍", category: "Entertainment"},
{name: "FilmBuff", avatar: "🎞️", category: "Entertainment"},
{name: "TVTrivia", avatar: "📺", category: "Entertainment"},
{name: "StarStruck", avatar: "🌟", category: "Entertainment"},
{name: "MusicMaestro", avatar: "🎵", category: "Entertainment"},
{name: "BeatBoxer", avatar: "🎧", category: "Entertainment"},

// Geography category
{name: "GlobeExplorer", avatar: "🌎", category: "Geography"},
{name: "MapMaster", avatar: "🗺️", category: "Geography"},
{name: "TravelGuide", avatar: "🧭", category: "Geography"},
{name: "WorldWanderer", avatar: "🚩", category: "Geography"},

// Technology category
{name: "TechWhiz", avatar: "💻", category: "Technology"},
{name: "CodeGuru", avatar: "👨‍💻", category: "Technology"},
{name: "DigitalMaster", avatar: "📱", category: "Technology"},
{name: "DataDiver", avatar: "📊", category: "Technology"}
];

// Hints for quizzes
const quizHints = {
"science_astronomy": [
"This planet gets its distinctive color from iron oxide (rust) on its surface."
],
"science_biology": [
"This organelle is often called the 'powerhouse' because it produces energy for the cell."
],
"science_chemistry": [
"The Latin word for this element is 'aurum'."
],
"geography_world": [
"This country is known as the Land of the Rising Sun.",
"This river is the longest in the world and flows through Egypt.",
"This mountain range separates Europe and Asia.",
"This desert is the largest hot desert in the world.",
"This country has the most natural lakes in the world."
],
"technology_computers": [
"This programming language was created by Guido van Rossum and is named after a comedy group.",
"This company was founded by Steve Jobs, Steve Wozniak, and Ronald Wayne.",
"This technology allows devices to connect wirelessly over short distances.",
"This social media platform was launched in 2004 by Mark Zuckerberg.",
"This term refers to a malicious software that encrypts your files and demands payment."
],
// Default hints for general quizzes
"default": [
"Consider the context and try to eliminate obviously wrong answers."
]
};

// Create quiz topics - adding more categories as requested
const allQuizzes = {
// Science Quiz
"science_astronomy": {
name: "Space & Astronomy",
category: "Science",
questions: [
{
question: "Which planet is known as the Red Planet?",
answers: ["Venus", "Mars", "Jupiter", "Saturn"],
correct: 1,
timeLimit: 20
},
{
question: "What is the largest planet in our solar system?",
answers: ["Earth", "Neptune", "Jupiter", "Saturn"],
correct: 2,
timeLimit: 15
},
{
question: "What is the name of our galaxy?",
answers: ["Andromeda", "Milky Way", "Black Eye", "Triangulum"],
correct: 1,
timeLimit: 15
},
{
question: "How many planets are in our solar system?",
answers: ["7", "8", "9", "10"],
correct: 1,
timeLimit: 15
},
{
question: "What is a shooting star?",
answers: ["A star moving through space", "A meteor", "A comet", "A satellite"],
correct: 1,
timeLimit: 20
}
]
},

// Technology Quiz - First New Topic
"technology_computers": {
name: "Computer Technology",
category: "Technology",
questions: [
{
question: "Which programming language is known for its use in web development and has the file extension .js?",
answers: ["Java", "JavaScript", "Python", "C++"],
correct: 1,
timeLimit: 20
},
{
question: "What company created the iPhone?",
answers: ["Microsoft", "Google", "Apple", "Samsung"],
correct: 2,
timeLimit: 15
},
{
question: "What does CPU stand for?",
answers: ["Central Processing Unit", "Computer Personal Unit", "Central Personal Utility", "Computer Processing Utility"],
correct: 0,
timeLimit: 15
},
{
question: "Which technology is used to connect devices wirelessly over short distances?",
answers: ["Wi-Fi", "Ethernet", "Bluetooth", "NFC"],
correct: 2,
timeLimit: 15
},
{
question: "What social media platform was founded by Mark Zuckerberg?",
answers: ["Twitter", "Facebook", "Instagram", "LinkedIn"],
correct: 1,
timeLimit: 15
}
]
},

// Geography Quiz - Second New Topic
"geography_world": {
name: "World Geography",
category: "Geography",
questions: [
{
question: "Which country is known as the Land of the Rising Sun?",
answers: ["China", "South Korea", "Japan", "Thailand"],
correct: 2,
timeLimit: 15
},
{
question: "What is the longest river in the world?",
answers: ["Amazon", "Nile", "Mississippi", "Yangtze"],
correct: 1,
timeLimit: 20
},
{
question: "Which mountain range separates Europe and Asia?",
answers: ["Alps", "Himalayas", "Andes", "Ural Mountains"],
correct: 3,
timeLimit: 20
},
{
question: "What is the largest desert in the world?",
answers: ["Sahara Desert", "Arabian Desert", "Gobi Desert", "Antarctic Desert"],
correct: 3,
timeLimit: 15
},
{
question: "Which country has the most natural lakes?",
answers: ["United States", "Russia", "Canada", "Finland"],
correct: 2,
timeLimit: 15
}
]
}
};

// Boss data for Boss Fight Mode
const bosses = [
  {
    id: "easy_boss",
    name: "Quiz Goblin",
    emoji: "👺",
    health: 100,
    damage: 5,
    attackSpeed: 3000, // ms between attacks
    attacks: ["🔥", "💥", "⚡️"],
    sounds: {
      hit: 300,
      attack: 200,
      defeat: 100
    }
  },
  {
    id: "medium_boss",
    name: "Knowledge Dragon",
    emoji: "🐉",
    health: 150,
    damage: 10,
    attackSpeed: 2500,
    attacks: ["🔥", "💥", "⚡️", "☄️"],
    sounds: {
      hit: 350,
      attack: 220,
      defeat: 120
    }
  },
  {
    id: "hard_boss",
    name: "Wisdom Wizard",
    emoji: "🧙‍♂️",
    health: 200,
    damage: 15,
    attackSpeed: 2000,
    attacks: ["🔮", "✨", "⚡️", "🌪️", "🌋"],
    sounds: {
      hit: 400,
      attack: 250,
      defeat: 150
    }
  }
];

// User-created quizzes storage
let userQuizzes = [];

// All possible quiz categories
const quizCategories = [
"Science", "History", "Geography", "Art", "Literature", "Music",
"Entertainment", "Sports", "Animals", "Food", "General", "Technology"
];

// Achievements system with coin rewards
const achievements = [
{
id: 'first_quiz',
name: 'First Steps',
description: 'Complete your first quiz',
icon: '🎯',
color: '#3A9F35',
unlocked: false,
reward: 10
},
{
id: 'perfect_score',
name: 'Perfect Score',
description: 'Get 100% on any quiz',
icon: '🏆',
color: '#F8B620',
unlocked: false,
reward: 25
},
{
id: 'speed_demon',
name: 'Speed Demon',
description: 'Finish a quiz within 10% of total quiz time',
icon: '⚡',
color: '#E21B3C',
unlocked: false,
reward: 50
},
{
id: 'quiz_master',
name: 'Quiz Master',
description: 'Complete 5 different quizzes',
icon: '🧠',
color: '#1368CE',
unlocked: false,
reward: 100
},
{
id: 'creator',
name: 'Quiz Creator',
description: 'Create your first quiz',
icon: '✏️',
color: '#7B5429',
unlocked: false,
reward: 50
},
{
id: 'coin_collector',
name: 'Coin Collector',
description: 'Collect 100 coins',
icon: '💰',
color: '#F8B620',
unlocked: false,
reward: 25
},
{
id: 'shopaholic',
name: 'Shopaholic',
description: 'Purchase your first avatar',
icon: '🛍️',
color: '#1368CE',
unlocked: false,
reward: 20
},
{
id: 'accessorizer',
name: 'Accessorizer',
description: 'Purchase your first accessory',
icon: '👑',
color: '#8A2BE2',
unlocked: false,
reward: 20
},
{
id: 'boss_slayer',
name: 'Boss Slayer',
description: 'Defeat a boss in Boss Fight mode',
icon: '⚔️',
color: '#E21B3C',
unlocked: false,
reward: 75
},
{
id: 'sudden_death_challenge',
name: 'Sudden Death Challenge',
description: 'Complete a quiz in Sudden Death Mode',
icon: '❤️',
color: '#E21B3C',
unlocked: false,
reward: 75
},
{
id: 'team_champion',
name: 'Team Champion',
description: 'Win a Team Battle against an AI opponent',
icon: '🏅',
color: '#FF8C00',
unlocked: false,
reward: 50
},
{
id: 'rich_quizzer',
name: 'Rich Quizzer',
description: 'Collect 1000 coins',
icon: '💎',
color: '#1368CE',
unlocked: false,
reward: 100
},
{
id: 'avatar_collector',
name: 'Avatar Collector',
description: 'Collect all available avatars',
icon: '🌟',
color: '#F8B620',
unlocked: false,
reward: 200
},
{
id: 'accessory_collector',
name: 'Accessory Collector',
description: 'Collect all available accessories',
icon: '🏆',
color: '#8A2BE2',
unlocked: false,
reward: 200
}
];

// Game state
let gameState = {
currentQuiz: null,
currentQuestionIndex: 0,
score: 0,
timer: null,
timeLeft: 0,
startTime: 0,
totalTime: 0,
correctAnswers: 0,
playerName: "",
playerAvatar: null,
playerAvatarId: null,
playerAccessory: null,
playerAccessoryId: null,
quizType: "",
hintsUsed: 0,
hintsAvailable: 1,
completedQuizzes: [],
highScores: {},
coins: 0,
gameMode: "standard", // Default to standard mode
unlockedAvatars: basicAvatars.map(a => a.id), // Start with basic avatars unlocked
unlockedAccessories: [], // Start with no accessories unlocked
streakCount: 0, // For tracking correct answer streaks
// Game results for non-standard modes
gameResults: {}, // Will store quizId -> {result: "win"|"loss", mode: "boss_fight"|"sudden_death"|"team_battle"}
// Boss Fight specific state
bossHealth: 0,
bossMaxHealth: 0,
currentBoss: null,
bossAttackInterval: null,
playerHealth: 100,
// Sudden Death specific state
lives: 1,
// Team Battle specific state
aiPlayer: null,
aiScore: 0,
playerScore: 0
};

// Audio context for sound effects
let audioContext = null;
let isSoundOn = false;
let isMusicOn = false;
let currentMusic = null;

// Check for shared quiz in URL on load
function checkForSharedQuiz() {
  // Get URL params
  const urlParams = new URLSearchParams(window.location.search);
  const sharedQuizData = urlParams.get('quiz');
  
  if (sharedQuizData) {
    try {
      // Decode and parse the quiz data
      const decodedData = decodeURIComponent(sharedQuizData);
      const quizObject = JSON.parse(decodedData);
      
      // Validate quiz data
      if (quizObject && quizObject.questions && quizObject.name && quizObject.category) {
        // Set an import ID so we know it's imported
        quizObject.id = 'imported_' + Date.now();
        quizObject.isImported = true;
        
        // Add to user quizzes
        userQuizzes.push(quizObject);
        
        // Save to storage
        saveData('userQuizzes', userQuizzes);
        
        // Show import notification after a short delay
        setTimeout(() => {
          const notification = document.createElement('div');
          notification.className = 'fixed top-4 right-4 bg-white shadow-lg rounded-lg p-4 z-50 flex items-center gap-3 animate-fade-in-up';
          notification.innerHTML = `
            <div class="w-10 h-10 flex items-center justify-center rounded-full bg-blue">
              <span class="text-xl text-white">📥</span>
            </div>
            <div>
              <div class="font-bold">Quiz Imported!</div>
              <div>"${quizObject.name}" has been added to your collection</div>
            </div>
            <button class="ml-2 text-gray-400 hover:text-gray-600">&times;</button>
          `;
          
          document.body.appendChild(notification);
          
          // Close button
          const closeBtn = notification.querySelector('button');
          closeBtn.addEventListener('click', () => {
            notification.remove();
          });
          
          // Auto remove after 5 seconds
          setTimeout(() => {
            notification.classList.add('opacity-0');
            notification.style.transition = 'opacity 0.5s ease';
            setTimeout(() => notification.remove(), 500);
          }, 5000);
        }, 1000);
        
        // Remove the query param to avoid re-importing on refresh
        window.history.replaceState({}, document.title, window.location.pathname);
      }
    } catch (error) {
      console.error('Error importing shared quiz:', error);
    }
  }
}

// Create a shareable link for a quiz
function createShareableLink(quiz) {
  // Create a copy of the quiz without the id to keep the link shorter
  const shareQuiz = { ...quiz };
  delete shareQuiz.id;
  delete shareQuiz.isImported;
  
  // Stringify and encode the quiz data
  const quizData = encodeURIComponent(JSON.stringify(shareQuiz));
  
  // Create the full URL with the current origin
  const shareableUrl = `${window.location.origin}${window.location.pathname}?quiz=${quizData}`;
  
  return shareableUrl;
}

// Load data from localStorage or memory storage
function loadSavedData() {
  try {
    // Load user quizzes
    const savedQuizzes = safeStorage.getItem('quizzer_userQuizzes');
    if (savedQuizzes) {
      userQuizzes = JSON.parse(savedQuizzes);
    }

    // Load user preferences
    const savedPreferences = safeStorage.getItem('quizzer_preferences');
    if (savedPreferences) {
      const preferences = JSON.parse(savedPreferences);
      // Load sound preferences
      if (preferences.soundOn !== undefined) {
        isSoundOn = preferences.soundOn;
      }
      if (preferences.musicOn !== undefined) {
        isMusicOn = preferences.musicOn;
      }
    }

    // Load achievements
    const savedAchievements = safeStorage.getItem('quizzer_achievements');
    if (savedAchievements) {
      const unlockedAchievements = JSON.parse(savedAchievements);
      // Update achievements
      achievements.forEach(achievement => {
        if (unlockedAchievements.includes(achievement.id)) {
          achievement.unlocked = true;
        }
      });
    }

    // Load completed quizzes, high scores, and game results
    const savedStats = safeStorage.getItem('quizzer_stats');
    if (savedStats) {
      const stats = JSON.parse(savedStats);
      if (stats.completedQuizzes) {
        gameState.completedQuizzes = stats.completedQuizzes;
      }
      if (stats.highScores) {
        gameState.highScores = stats.highScores;
      }
      if (stats.coins) {
        gameState.coins = stats.coins;
      }
      if (stats.gameResults) {
        gameState.gameResults = stats.gameResults;
      }
    }

    // Load unlocked avatars
    const savedAvatars = safeStorage.getItem('quizzer_avatars');
    if (savedAvatars) {
      gameState.unlockedAvatars = JSON.parse(savedAvatars);
    }
    
    // Load unlocked accessories
    const savedAccessories = safeStorage.getItem('quizzer_accessories');
    if (savedAccessories) {
      gameState.unlockedAccessories = JSON.parse(savedAccessories);
    }
    
    // Check for shared quiz in URL parameters
    checkForSharedQuiz();
    
  } catch (error) {
    console.log('Error loading saved data:', error);
  }
}

// Save data to localStorage or memory storage
function saveData(key, data) {
  try {
    safeStorage.setItem('quizzer_' + key, JSON.stringify(data));
  } catch (error) {
    console.log(`Error saving ${key} data:`, error);
  }
}

// Unlock achievement
function unlockAchievement(achievementId) {
  const achievement = achievements.find(a => a.id === achievementId);
  if (achievement && !achievement.unlocked) {
    achievement.unlocked = true;

    // Award coins for achievement
    const coinsAwarded = achievement.reward || 0;
    if (coinsAwarded > 0) {
      gameState.coins += coinsAwarded;
      
      // Save stats with updated coins
      saveData('stats', {
        completedQuizzes: gameState.completedQuizzes,
        highScores: gameState.highScores,
        coins: gameState.coins,
        gameResults: gameState.gameResults
      });
    }

    // Save achievements
    const unlockedIds = achievements.filter(a => a.unlocked).map(a => a.id);
    saveData('achievements', unlockedIds);

    // Show achievement notification with reward
    showAchievementNotification(achievement, coinsAwarded);
    
    // Check for collector achievements
    checkCollectorAchievements();
  }
}

// Show achievement notification
function showAchievementNotification(achievement, coinsAwarded) {
  const notification = document.createElement('div');
  notification.className = 'fixed top-4 right-4 bg-white shadow-lg rounded-lg p-4 z-50 flex items-center gap-3 animate-fade-in-up';
  notification.innerHTML = `
<div class="w-10 h-10 flex items-center justify-center rounded-full" style="background-color: ${achievement.color}">
<span class="text-xl">${achievement.icon}</span>
</div>
<div>
<div class="font-bold">Achievement Unlocked!</div>
<div>${achievement.name}: ${achievement.description}</div>
${coinsAwarded > 0 ? `<div class="text-yellow-600 font-bold reward-pulse">+${coinsAwarded} coins</div>` : ''}
</div>
<button class="ml-2 text-gray-400 hover:text-gray-600">&times;</button>
`;

  document.body.appendChild(notification);

  // Play coin sound if reward was given
  if (coinsAwarded > 0) {
    playCoinSound();
  }

  // Close button
  const closeBtn = notification.querySelector('button');
  closeBtn.addEventListener('click', () => {
    notification.remove();
  });

  // Auto remove after 5 seconds
  setTimeout(() => {
    notification.classList.add('opacity-0');
    notification.style.transition = 'opacity 0.5s ease';
    setTimeout(() => notification.remove(), 500);
  }, 5000);
}

// Check collector achievements
function checkCollectorAchievements() {
  // Rich Quizzer achievement
  if (gameState.coins >= 1000 && 
      !achievements.find(a => a.id === 'rich_quizzer').unlocked) {
    unlockAchievement('rich_quizzer');
  }
  
  // Avatar Collector achievement
  const totalPremiumAvatars = premiumAvatars.length;
  const unlockedPremiumAvatars = premiumAvatars.filter(a => 
    gameState.unlockedAvatars.includes(a.id)
  ).length;
  
  if (unlockedPremiumAvatars === totalPremiumAvatars && 
      !achievements.find(a => a.id === 'avatar_collector').unlocked) {
    unlockAchievement('avatar_collector');
  }
  
  // Accessory Collector achievement
  const totalAccessories = accessories.length;
  const unlockedAccessoryCount = gameState.unlockedAccessories.length;
  
  if (unlockedAccessoryCount === totalAccessories && 
      !achievements.find(a => a.id === 'accessory_collector').unlocked) {
    unlockAchievement('accessory_collector');
  }
}

// Check achievements after quiz
function checkAchievements(quizResults) {
  // First quiz
  if (!achievements.find(a => a.id === 'first_quiz').unlocked) {
    unlockAchievement('first_quiz');
  }

  // Perfect score
  if (quizResults.correctAnswers === quizResults.totalQuestions &&
  !achievements.find(a => a.id === 'perfect_score').unlocked) {
    unlockAchievement('perfect_score');
  }

  // Speed demon - Changed to within 10% of total quiz time
  const totalQuizTime = quizResults.totalQuestions * 15; // Average time limit
  const speedThreshold = totalQuizTime * 0.1; // 10% of total quiz time
  
  if (quizResults.totalTime <= speedThreshold &&
  !achievements.find(a => a.id === 'speed_demon').unlocked) {
    unlockAchievement('speed_demon');
  }

  // Quiz master (5 different quizzes)
  const completedQuizTypes = new Set(gameState.completedQuizzes);
  if (completedQuizTypes.size >= 5 &&
  !achievements.find(a => a.id === 'quiz_master').unlocked) {
    unlockAchievement('quiz_master');
  }

  // Coin collector
  if (gameState.coins >= 100 &&
  !achievements.find(a => a.id === 'coin_collector').unlocked) {
    unlockAchievement('coin_collector');
  }
  
  // Game mode specific achievements
  if (gameState.gameMode === 'sudden_death' && !achievements.find(a => a.id === 'sudden_death_challenge').unlocked) {
    unlockAchievement('sudden_death_challenge');
  }
  
  if (gameState.gameMode === 'team_battle' && gameState.playerScore > gameState.aiScore && 
      !achievements.find(a => a.id === 'team_champion').unlocked) {
    unlockAchievement('team_champion');
  }
}

// Initialize audio
function initAudio() {
  try {
    window.AudioContext = window.AudioContext || window.webkitAudioContext;
    audioContext = new AudioContext();
  } catch(e) {
    console.log("Web Audio API is not supported in this browser");
  }
}

// Create a simple tone
function playTone(frequency, duration, type = 'sine', volume = 0.1) {
  if (!audioContext || !isSoundOn) return;

  try {
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();

    oscillator.type = type;
    oscillator.frequency.value = frequency;
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);

    gainNode.gain.value = volume;

    oscillator.start();

    setTimeout(() => {
      oscillator.stop();
    }, duration);
  } catch(e) {
    console.log("Error playing tone:", e);
  }
}

// Play correct answer sound
function playCorrectSound() {
  playTone(600, 100, 'sine', 0.1);
  setTimeout(() => playTone(800, 200, 'sine', 0.1), 100);
  setTimeout(() => playTone(1000, 300, 'sine', 0.1), 300);
}

// Play wrong answer sound
function playWrongSound() {
  playTone(300, 200, 'sawtooth', 0.1);
  setTimeout(() => playTone(200, 300, 'sawtooth', 0.1), 200);
}

// Play click sound
function playClickSound() {
  playTone(500, 50, 'sine', 0.05);
}

// Play hint sound
function playHintSound() {
  playTone(700, 100, 'sine', 0.05);
  setTimeout(() => playTone(900, 100, 'sine', 0.05), 150);
}

// Play gold/coin collect sound
function playCoinSound() {
  playTone(800, 100, 'sine', 0.07);
  setTimeout(() => playTone(1200, 150, 'sine', 0.07), 100);
}

// Play boss hit sound
function playBossHitSound() {
  playTone(400, 100, 'square', 0.05);
  setTimeout(() => playTone(300, 150, 'square', 0.05), 100);
}

// Play player hit sound
function playPlayerHitSound() {
  playTone(200, 100, 'square', 0.08);
  setTimeout(() => playTone(150, 150, 'square', 0.08), 100);
}

// Play boss defeat sound
function playBossDefeatSound() {
  playTone(600, 150, 'sine', 0.1);
  setTimeout(() => playTone(800, 200, 'sine', 0.1), 150);
  setTimeout(() => playTone(1000, 250, 'sine', 0.1), 350);
  setTimeout(() => playTone(1200, 300, 'sine', 0.1), 600);
}

// Play life lost sound
function playLifeLostSound() {
  playTone(400, 100, 'sine', 0.1);
  playTone(300, 150, 'sine', 0.1);
  playTone(200, 200, 'sine', 0.1);
}

// Play streak sound
function playStreakSound() {
  playTone(700, 80, 'sine', 0.08);
  setTimeout(() => playTone(900, 80, 'sine', 0.08), 100);
  setTimeout(() => playTone(1100, 100, 'sine', 0.08), 200);
}

// Music management
function playMusic(trackId) {
  if (!isMusicOn) return;
  
  // Stop any currently playing music
  stopMusic();
  
  // Play the requested track
  const track = document.getElementById(trackId);
  if (track) {
    track.volume = 0.3; // Set lower volume for background music
    track.play()
      .catch(e => console.log('Error playing music:', e));
    currentMusic = track;
  }
}

function stopMusic() {
  // Stop all audio elements
  const audioElements = document.querySelectorAll('audio');
  audioElements.forEach(audio => {
    audio.pause();
    audio.currentTime = 0;
  });
  
  currentMusic = null;
}

// Launch confetti animation
function launchConfetti() {
  confetti({
    particleCount: 100,
    spread: 70,
    origin: { y: 0.6 }
  });
}

// Create jungle background for home/main screens
function createJungleBackground() {
  const leafContainer = document.createElement('div');
  leafContainer.className = 'floating-shapes';
  
  const appContainer = document.getElementById('app-container');
  if (appContainer) {
    const existingShapes = appContainer.querySelector('.floating-shapes');
    if (existingShapes) {
      existingShapes.remove();
    }
    
    appContainer.prepend(leafContainer);
  }
  
  const leafTypes = ['🍃', '🌿', '🍂', '🌴'];

  // Create leaves
  for (let i = 0; i < 10; i++) {
    const leaf = document.createElement('div');
    leaf.className = 'leaf';
    leaf.textContent = leafTypes[Math.floor(Math.random() * leafTypes.length)];

    // Set random size
    const size = Math.random() * 20 + 20;
    leaf.style.fontSize = `${size}px`;

    // Random position
    leaf.style.left = `${Math.random() * 100}%`;
    leaf.style.top = `${Math.random() * 100}%`;

    // Random animation duration
    const duration = Math.random() * 40 + 30;
    leaf.style.animationDuration = `${duration}s`;

    // Random delay
    leaf.style.animationDelay = `${Math.random() * 15}s`;

    leafContainer.appendChild(leaf);
  }
}

// Create background for different game modes
function createGameModeBackground(mode) {
  const appContainer = document.getElementById('app-container');
  if (!appContainer) return;
  
  // Remove any existing background class
  appContainer.className = '';
  
  // Add appropriate background based on mode
  switch(mode) {
    case 'standard':
      appContainer.classList.add('bg-standard-mode-light');
      break;
    case 'boss_fight':
      appContainer.classList.add('bg-boss-fight-light');
      break;
    case 'sudden_death':
      appContainer.classList.add('bg-sudden-death-light');
      break;
    case 'team_battle':
      appContainer.classList.add('bg-team-battle-light');
      break;
    default:
      // Default jungle background for home/menu screens
      appContainer.classList.add('bg-pattern-light');
      createJungleBackground();
  }
}

// Setup sound control
function setupSoundControl() {
  const soundControl = document.getElementById('sound-control');
  const soundIcon = document.getElementById('sound-icon');

  if (!soundControl || !soundIcon) return;

  // Update sound icon
  const updateSoundIcon = () => {
    soundIcon.textContent = isSoundOn ? '🔊' : '🔇';
  };

  // Initial icon states
  updateSoundIcon();

  // Initialize audio when clicking anywhere
  document.addEventListener('click', function initAudioOnFirstClick() {
    if (audioContext === null) {
      initAudio();
      document.removeEventListener('click', initAudioOnFirstClick);
    }
  }, { once: true });

  // Toggle sound on click
  soundControl.addEventListener('click', () => {
    isSoundOn = !isSoundOn;
    playClickSound(); // This will only make sound if isSoundOn is true

    // Update icon
    updateSoundIcon();

    // Save preference
    try {
      saveData('preferences', { soundOn: isSoundOn, musicOn: isMusicOn });
    } catch (e) {
      console.log("Error saving sound preference:", e);
    }
  });
}

// Start the countdown animation before quiz
function startCountdown(callback) {
  const countdownOverlay = document.getElementById('countdown-overlay');
  const countdownDisplay = document.getElementById('countdown-display');

  if (!countdownOverlay || !countdownDisplay) return callback();

  countdownOverlay.classList.remove('hidden');

  let count = 3;

  const updateDisplay = () => {
    countdownDisplay.textContent = count;
    countdownDisplay.classList.remove('countdown-number');
    void countdownDisplay.offsetWidth; // Force reflow
    countdownDisplay.classList.add('countdown-number');

    if (count === 3) playTone(400, 200);
    if (count === 2) playTone(500, 200);
    if (count === 1) playTone(600, 200);

    count--;

    if (count >= 0) {
      setTimeout(updateDisplay, 1000);
    } else {
      countdownDisplay.textContent = 'GO!';
      countdownDisplay.classList.remove('countdown-number');
      void countdownDisplay.offsetWidth; // Force reflow
      countdownDisplay.classList.add('countdown-number');

      playTone(800, 300);

      setTimeout(() => {
        countdownOverlay.classList.add('hidden');
        callback();
      }, 800);
    }
  };

  updateDisplay();
}

// Helper function to get accessory position class
function getAccessoryPositionClass(accessoryId) {
  switch(accessoryId) {
    case 'crown': return 'accessory-crown';
    case 'glasses': return 'accessory-glasses';
    case 'hat': return 'accessory-hat';
    case 'bowtie': return 'accessory-bowtie';
    case 'necktie': return 'accessory-necktie';
    case 'headphones': return 'accessory-headphones';
    case 'diploma': return 'accessory-diploma';
    default: return '';
  }
}

// Helper function to render avatar with accessory
function renderAvatarWithAccessory(avatarEmoji, accessoryId, containerClass = '') {
  const accessory = accessories.find(a => a.id === accessoryId);
  if (!avatarEmoji) return '';
  
  if (!accessory) {
    return `<div class="${containerClass} relative">${avatarEmoji}</div>`;
  }
  
  const positionClass = getAccessoryPositionClass(accessoryId);
  
  return `
  <div class="${containerClass} relative">
    ${avatarEmoji}
    <div class="accessory ${positionClass}">${accessory.emoji}</div>
  </div>`;
}

// Render main menu (new starting screen)
function renderMainMenu() {
  const container = document.getElementById('app-container');
  if (!container) {
    console.error('Container not found');
    return;
  }

  // Set background for menu
  createGameModeBackground('menu');
  
  // Start menu music if music is enabled
  if (isMusicOn) {
    playMusic('menu-music');
  }

  // Count unlocked achievements
  const unlockedCount = achievements.filter(a => a.unlocked).length;
  const totalAchievements = achievements.length;

  container.innerHTML = `
<div class="container mx-auto px-4 py-8 max-w-4xl relative z-10">
<div class="flex flex-col items-center justify-center min-h-[80vh]">
<div class="absolute right-4 top-4 flex gap-2">
<button id="achievements-btn" class="tooltip p-2 rounded-full bg-white/80 hover:bg-white/100 transition-colors">
<i class="fas fa-trophy text-yellow-500"></i>
<span class="tooltip-text">Achievements (${unlockedCount}/${totalAchievements})</span>
</button>
<button id="shop-btn" class="tooltip p-2 rounded-full bg-white/80 hover:bg-white/100 transition-colors">
<i class="fas fa-store text-primary"></i>
<span class="tooltip-text">Avatar Shop</span>
</button>
<div class="coin-balance">
<div class="coin-icon">💰</div>
<span id="coin-display">${gameState.coins}</span>
</div>
</div>

<!-- Logo -->
<div class="logo-container mb-5">
  <div class="logo">
    <div class="logo-orbit"></div>
    <div class="logo-circle">
      <div class="logo-letter">Q</div>
    </div>
    <div class="logo-orbit">
      <div class="logo-planet"></div>
    </div>
  </div>
</div>

<h1 class="text-5xl font-bold mb-6 text-center text-primary drop-shadow-md">Quizzer</h1>
<p class="text-xl mb-12 text-center">Fun educational quizzes for curious minds!</p>

<div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-3xl mb-12">
<!-- Play Quizzes Card -->
<div class="content-card bg-white/90 rounded-lg p-6 backdrop-blur shadow-lg hover:shadow-xl action-card">
<div class="text-4xl mb-6 text-center text-primary">🎮</div>
<h2 class="text-2xl font-bold mb-4 text-center">Play Quizzes</h2>
<p class="mb-6 text-center">Test your knowledge with pre-made quizzes or play quizzes created by others.</p>
<button id="play-quizzes-btn" class="w-full bg-primary hover:bg-primary/90 text-white font-bold py-3 px-4 rounded-lg transition-colors">
Start Playing
</button>
</div>

<!-- Create Quizzes Card -->
<div class="content-card bg-white/90 rounded-lg p-6 backdrop-blur shadow-lg hover:shadow-xl action-card">
<div class="text-4xl mb-6 text-center text-secondary">✏️</div>
<h2 class="text-2xl font-bold mb-4 text-center">Create Quizzes</h2>
<p class="mb-6 text-center">Make your own quizzes with custom questions and answers to share with others.</p>
<button id="create-quizzes-btn" class="w-full bg-secondary hover:bg-secondary/90 text-white font-bold py-3 px-4 rounded-lg transition-colors">
Start Creating
</button>
</div>
</div>
</div>
</div>
`;

  // Add event listeners
  const playQuizzesBtn = document.getElementById('play-quizzes-btn');
  const createQuizzesBtn = document.getElementById('create-quizzes-btn');
  const achievementsBtn = document.getElementById('achievements-btn');
  const shopBtn = document.getElementById('shop-btn');

  if (playQuizzesBtn) {
    playQuizzesBtn.addEventListener('click', function() {
      playClickSound();
      renderWelcomeScreen();
    });
  }

  if (createQuizzesBtn) {
    createQuizzesBtn.addEventListener('click', function() {
      playClickSound();
      renderCreateQuizScreen();
    });
  }

  if (achievementsBtn) {
    achievementsBtn.addEventListener('click', function() {
      playClickSound();
      renderAchievementsScreen();
    });
  }

  if (shopBtn) {
    shopBtn.addEventListener('click', function() {
      playClickSound();
      renderShopScreen();
    });
  }
}

// Render achievements screen
function renderAchievementsScreen() {
  const container = document.getElementById('app-container');
  if (!container) return;

  // Create background
  createGameModeBackground('menu');

  // Create HTML for each achievement
  const achievementsHTML = achievements.map(achievement => {
    const lockedClass = achievement.unlocked ? '' : 'achievement-locked';
    const rewardText = achievement.unlocked ? 
      '<span class="text-yellow-600">Awarded</span>' : 
      `<span class="text-yellow-600">${achievement.reward} coins</span>`;

    return `
<div class="achievement ${lockedClass}">
<div class="achievement-icon text-white" style="background-color: ${achievement.color}">
${achievement.icon}
</div>
<div class="flex-1">
<div class="font-bold">${achievement.name}</div>
<div class="text-sm">${achievement.description}</div>
</div>
<div class="text-sm">
${rewardText}
</div>
</div>
`;
  }).join('');

  container.innerHTML = `
<div class="container mx-auto px-4 py-8 max-w-4xl relative z-10">
<div class="flex items-center justify-between mb-6">
<h1 class="text-3xl font-bold text-primary drop-shadow-md">Achievements</h1>
<div class="flex items-center gap-3">
<div class="coin-balance">
<div class="coin-icon">💰</div>
<span id="coin-display">${gameState.coins}</span>
</div>
<button id="back-to-menu-btn" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
<i class="fas fa-arrow-left mr-2"></i>Back to Menu
</button>
</div>
</div>

<div class="content-card bg-white/90 rounded-lg p-6 backdrop-blur mb-8 animate-fade-in">
<p class="mb-4">Complete challenges to unlock achievements and earn coins!</p>

<div class="achievements-container">
${achievementsHTML}
</div>
</div>
</div>
`;

  // Add event listeners
  const backBtn = document.getElementById('back-to-menu-btn');
  if (backBtn) {
    backBtn.addEventListener('click', function() {
      playClickSound();
      renderMainMenu();
    });
  }
}

// Render avatar shop screen
function renderShopScreen() {
  const container = document.getElementById('app-container');
  if (!container) return;

  // Create background
  createGameModeBackground('menu');

  // Prepare shop items HTML for avatars
  let avatarItemsHTML = '';

  // Add premium avatars to shop
  premiumAvatars.forEach(avatar => {
    const isUnlocked = gameState.unlockedAvatars.includes(avatar.id);
    const buttonClass = isUnlocked ? 'bg-green-500 hover:bg-green-600' : 'bg-primary hover:bg-primary/90';
    const buttonText = isUnlocked ? 'Owned' : `Buy - ${avatar.price} coins`;
    const disabled = isUnlocked || gameState.coins < avatar.price ? 'disabled' : '';
    const opacity = isUnlocked || gameState.coins >= avatar.price ? 'opacity-100' : 'opacity-50';

    avatarItemsHTML += `
<div class="shop-item ${opacity}">
<div class="shop-item-icon">${avatar.emoji}</div>
<div class="shop-item-details">
<div class="font-bold">${avatar.name}</div>
<div class="text-xs">${isUnlocked ? 'Already unlocked' : `Price: ${avatar.price} coins`}</div>
</div>
<button class="px-3 py-1 ml-2 text-white rounded-lg ${buttonClass} avatar-buy-btn" data-avatar-id="${avatar.id}" ${disabled}>
${buttonText}
</button>
</div>
`;
  });

  // Prepare accessories shop HTML
  let accessoriesHTML = '';
  
  accessories.forEach(accessory => {
    const isUnlocked = gameState.unlockedAccessories.includes(accessory.id);
    const buttonClass = isUnlocked ? 'bg-green-500 hover:bg-green-600' : 'bg-purple hover:bg-purple/90';
    const buttonText = isUnlocked ? 'Owned' : `Buy - ${accessory.price} coins`;
    const disabled = isUnlocked || gameState.coins < accessory.price ? 'disabled' : '';
    const opacity = isUnlocked || gameState.coins >= accessory.price ? 'opacity-100' : 'opacity-50';

    accessoriesHTML += `
<div class="shop-item ${opacity}">
<div class="shop-item-icon">${accessory.emoji}</div>
<div class="shop-item-details">
<div class="font-bold">${accessory.name}</div>
<div class="text-xs">${isUnlocked ? 'Already unlocked' : `Price: ${accessory.price} coins`}</div>
</div>
<button class="px-3 py-1 ml-2 text-white rounded-lg ${buttonClass} accessory-buy-btn" data-accessory-id="${accessory.id}" ${disabled}>
${buttonText}
</button>
</div>
`;
  });

  container.innerHTML = `
<div class="container mx-auto px-4 py-8 max-w-4xl relative z-10">
<div class="flex items-center justify-between mb-6">
<h1 class="text-3xl font-bold text-primary drop-shadow-md">Shop</h1>
<div class="flex items-center gap-3">
<div class="coin-balance">
<div class="coin-icon">💰</div>
<span id="coin-display">${gameState.coins}</span>
</div>
<button id="back-to-menu-btn" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
<i class="fas fa-arrow-left mr-2"></i>Back to Menu
</button>
</div>
</div>

<div class="flex mb-2">
<div id="avatars-tab" class="shop-tab active">Avatars</div>
<div id="accessories-tab" class="shop-tab">Accessories</div>
</div>

<div id="avatars-section" class="content-card bg-white/90 rounded-lg p-6 backdrop-blur mb-8 animate-fade-in">
<div class="mb-4">
<h2 class="text-xl font-bold">Premium Avatars</h2>
<p class="text-sm text-gray-600">Use your coins to unlock special avatars for your profile.</p>
</div>

<div class="shop-items">
${avatarItemsHTML}
</div>
</div>

<div id="accessories-section" class="content-card bg-white/90 rounded-lg p-6 backdrop-blur mb-8 animate-fade-in hidden">
<div class="mb-4">
<h2 class="text-xl font-bold">Accessories</h2>
<p class="text-sm text-gray-600">Style your avatar with these fun accessories!</p>
</div>

<div class="shop-items">
${accessoriesHTML}
</div>
</div>

<div class="content-card bg-white/90 rounded-lg p-6 backdrop-blur mb-8 animate-fade-in" style="animation-delay: 0.1s">
<h2 class="text-xl font-bold mb-4">How to Earn Coins</h2>
<div class="space-y-3">
<div>
<div class="flex items-center text-primary mb-1 font-medium">
<i class="fas fa-check-circle mr-2"></i>Complete Quizzes
</div>
<p class="text-sm text-gray-600 ml-7">Earn coins equal to the number of correct answers.</p>
</div>
<div>
<div class="flex items-center text-primary mb-1 font-medium">
<i class="fas fa-check-circle mr-2"></i>Boss Fights
</div>
<p class="text-sm text-gray-600 ml-7">Earn bonus coins for defeating bosses.</p>
</div>
<div>
<div class="flex items-center text-primary mb-1 font-medium">
<i class="fas fa-check-circle mr-2"></i>Perfect Scores
</div>
<p class="text-sm text-gray-600 ml-7">Get bonus coins for answering all questions correctly.</p>
</div>
<div>
<div class="flex items-center text-primary mb-1 font-medium">
<i class="fas fa-check-circle mr-2"></i>Unlock Achievements
</div>
<p class="text-sm text-gray-600 ml-7">Each achievement gives a one-time coin reward!</p>
</div>
</div>
</div>
</div>
`;

  // Add event listeners
  const backBtn = document.getElementById('back-to-menu-btn');
  if (backBtn) {
    backBtn.addEventListener('click', function() {
      playClickSound();
      renderMainMenu();
    });
  }

  // Tab controls
  const avatarsTab = document.getElementById('avatars-tab');
  const accessoriesTab = document.getElementById('accessories-tab');
  const avatarsSection = document.getElementById('avatars-section');
  const accessoriesSection = document.getElementById('accessories-section');
  
  if (avatarsTab && accessoriesTab && avatarsSection && accessoriesSection) {
    avatarsTab.addEventListener('click', function() {
      playClickSound();
      avatarsTab.classList.add('active');
      accessoriesTab.classList.remove('active');
      avatarsSection.classList.remove('hidden');
      accessoriesSection.classList.add('hidden');
    });
    
    accessoriesTab.addEventListener('click', function() {
      playClickSound();
      accessoriesTab.classList.add('active');
      avatarsTab.classList.remove('active');
      accessoriesSection.classList.remove('hidden');
      avatarsSection.classList.add('hidden');
    });
  }

  // Add buy button event listeners for avatars
  const avatarBuyButtons = document.querySelectorAll('.avatar-buy-btn:not([disabled])');
  avatarBuyButtons.forEach(button => {
    button.addEventListener('click', function() {
      const avatarId = this.getAttribute('data-avatar-id');
      const avatar = premiumAvatars.find(a => a.id === avatarId);

      if (avatar && !gameState.unlockedAvatars.includes(avatarId)) {
        // Check if user has enough coins
        if (gameState.coins >= avatar.price) {
          // Deduct coins
          gameState.coins -= avatar.price;

          // Add to unlocked avatars
          gameState.unlockedAvatars.push(avatarId);

          // Save data
          saveData('stats', {
            completedQuizzes: gameState.completedQuizzes,
            highScores: gameState.highScores,
            coins: gameState.coins,
            gameResults: gameState.gameResults
          });
          saveData('avatars', gameState.unlockedAvatars);

          // Play sound
          playCoinSound();

          // Update display
          const coinDisplay = document.getElementById('coin-display');
          if (coinDisplay) {
            coinDisplay.textContent = gameState.coins;
            coinDisplay.classList.add('coin-animation');
            setTimeout(() => coinDisplay.classList.remove('coin-animation'), 500);
          }

          // Update button to show it's purchased
          this.innerHTML = 'Owned';
          this.classList.remove('bg-primary', 'hover:bg-primary/90');
          this.classList.add('bg-green-500', 'hover:bg-green-600');
          this.disabled = true;

          // Unlock achievement if first purchase
          if (!achievements.find(a => a.id === 'shopaholic').unlocked) {
            unlockAchievement('shopaholic');
          }
          
          // Check collector achievements
          checkCollectorAchievements();
        }
      }
    });
  });
  
  // Add buy button event listeners for accessories
  const accessoryBuyButtons = document.querySelectorAll('.accessory-buy-btn:not([disabled])');
  accessoryBuyButtons.forEach(button => {
    button.addEventListener('click', function() {
      const accessoryId = this.getAttribute('data-accessory-id');
      const accessory = accessories.find(a => a.id === accessoryId);

      if (accessory && !gameState.unlockedAccessories.includes(accessoryId)) {
        // Check if user has enough coins
        if (gameState.coins >= accessory.price) {
          // Deduct coins
          gameState.coins -= accessory.price;

          // Add to unlocked accessories
          gameState.unlockedAccessories.push(accessoryId);

          // Save data
          saveData('stats', {
            completedQuizzes: gameState.completedQuizzes,
            highScores: gameState.highScores,
            coins: gameState.coins,
            gameResults: gameState.gameResults
          });
          saveData('accessories', gameState.unlockedAccessories);

          // Play sound
          playCoinSound();

          // Update display
          const coinDisplay = document.getElementById('coin-display');
          if (coinDisplay) {
            coinDisplay.textContent = gameState.coins;
            coinDisplay.classList.add('coin-animation');
            setTimeout(() => coinDisplay.classList.remove('coin-animation'), 500);
          }

          // Update button to show it's purchased
          this.innerHTML = 'Owned';
          this.classList.remove('bg-purple', 'hover:bg-purple/90');
          this.classList.add('bg-green-500', 'hover:bg-green-600');
          this.disabled = true;

          // Unlock achievement if first purchase
          if (!achievements.find(a => a.id === 'accessorizer').unlocked) {
            unlockAchievement('accessorizer');
          }
          
          // Check collector achievements
          checkCollectorAchievements();
        }
      }
    });
  });
}

// Render create quiz screen
function renderCreateQuizScreen() {
  const container = document.getElementById('app-container');
  if (!container) {
    console.error('Container not found');
    return;
  }

  // Create background
  createGameModeBackground('menu');

  container.innerHTML = `
<div class="container mx-auto px-4 py-8 max-w-4xl relative z-10">
<div class="flex items-center justify-between mb-6">
<h1 class="text-3xl font-bold text-primary drop-shadow-md">Create Quiz</h1>
<div class="flex items-center gap-3">
<div class="coin-balance">
<div class="coin-icon">💰</div>
<span id="coin-display">${gameState.coins}</span>
</div>
<button id="back-to-menu-btn" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
<i class="fas fa-arrow-left mr-2"></i>Back to Menu
</button>
</div>
</div>

<div class="content-card bg-white/90 rounded-lg p-6 backdrop-blur mb-8 animate-fade-in">
<h2 class="text-xl font-bold mb-4">Quiz Details</h2>

<div class="space-y-4 mb-6">
<div>
<label for="quiz-title" class="block text-sm font-medium mb-2">Quiz Title</label>
<input type="text" id="quiz-title" class="w-full p-3 border rounded-lg text-base bg-white text-gray-900 border-gray-300 focus:ring-2 focus:ring-primary focus:border-primary" placeholder="Enter quiz title...">
</div>

<div>
<label for="quiz-category" class="block text-sm font-medium mb-2">Category</label>
<select id="quiz-category" class="w-full p-3 border rounded-lg text-base bg-white text-gray-900 border-gray-300 focus:ring-2 focus:ring-primary focus:border-primary">
<option value="">-- Select a Category --</option>
${quizCategories.map(category => `<option value="${category}">${category}</option>`).join('')}
</select>
</div>
</div>
</div>

<div class="content-card bg-white/90 rounded-lg p-6 backdrop-blur mb-8 animate-fade-in" style="animation-delay: 0.1s">
<div class="flex justify-between items-center mb-4">
<h2 class="text-xl font-bold">Questions</h2>
<button id="add-question-btn" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
<i class="fas fa-plus mr-2"></i>Add Question
</button>
</div>

<div id="questions-container" class="space-y-6">
<!-- Questions will be added here -->
<div class="text-center text-gray-500 py-8">
No questions added yet. Click "Add Question" to start building your quiz.
</div>
</div>
</div>

<div class="flex justify-end animate-fade-in" style="animation-delay: 0.2s">
<button id="save-quiz-btn" class="px-6 py-3 bg-secondary text-white rounded-lg hover:bg-secondary/90 transition-colors font-bold">
<i class="fas fa-save mr-2"></i>Save Quiz
</button>
</div>
</div>
`;

  // Add event listeners
  const backToMenuBtn = document.getElementById('back-to-menu-btn');
  const addQuestionBtn = document.getElementById('add-question-btn');
  const saveQuizBtn = document.getElementById('save-quiz-btn');

  if (backToMenuBtn) {
    backToMenuBtn.addEventListener('click', function() {
      playClickSound();
      renderMainMenu();
    });
  }

  if (addQuestionBtn) {
    addQuestionBtn.addEventListener('click', function() {
      playClickSound();
      addNewQuestion();
    });
  }

  if (saveQuizBtn) {
    saveQuizBtn.addEventListener('click', function() {
      playClickSound();
      saveQuiz();
    });
  }
}

// Add a new question to the create quiz form
function addNewQuestion() {
  const questionsContainer = document.getElementById('questions-container');
  if (!questionsContainer) return;

  // Remove the "no questions" message if present
  if (questionsContainer.querySelector('.text-gray-500')) {
    questionsContainer.innerHTML = '';
  }

  const questionId = 'question-' + Date.now();
  const questionHTML = `
<div id="${questionId}" class="question-card border border-gray-200 rounded-lg p-4 relative animate-slide-in">
<div class="absolute top-2 right-2 question-actions">
<button class="text-red-500 hover:text-red-700 delete-question-btn" data-question-id="${questionId}">
<i class="fas fa-trash"></i>
</button>
</div>

<div class="mb-4">
<label class="block text-sm font-medium mb-2">Question</label>
<input type="text" class="question-text w-full p-3 border rounded-lg text-base bg-white text-gray-900 border-gray-300 focus:ring-2 focus:ring-primary focus:border-primary" placeholder="Enter your question...">
</div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
<div>
<label class="block text-sm font-medium mb-2">Time Limit (seconds)</label>
<select class="time-limit w-full p-3 border rounded-lg text-base bg-white text-gray-900 border-gray-300 focus:ring-2 focus:ring-primary focus:border-primary">
<option value="10">10 seconds</option>
<option value="15" selected>15 seconds</option>
<option value="20">20 seconds</option>
<option value="30">30 seconds</option>
</select>
</div>

<div>
<label class="block text-sm font-medium mb-2">Hint (optional)</label>
<input type="text" class="question-hint w-full p-3 border rounded-lg text-base bg-white text-gray-900 border-gray-300 focus:ring-2 focus:ring-primary focus:border-primary" placeholder="Add a hint for this question...">
</div>
</div>

<div class="mb-4">
<label class="block text-sm font-medium mb-2">Answers</label>
<div class="space-y-3 answers-container">
<div class="flex items-center gap-2">
<input type="radio" name="correct-${questionId}" value="0" class="correct-answer" checked>
<input type="text" class="answer-text w-full p-3 border rounded-lg text-base bg-white text-gray-900 border-gray-300 focus:ring-2 focus:ring-primary focus:border-primary" placeholder="Answer option 1">
</div>
<div class="flex items-center gap-2">
<input type="radio" name="correct-${questionId}" value="1" class="correct-answer">
<input type="text" class="answer-text w-full p-3 border rounded-lg text-base bg-white text-gray-900 border-gray-300 focus:ring-2 focus:ring-primary focus:border-primary" placeholder="Answer option 2">
</div>
<div class="flex items-center gap-2">
<input type="radio" name="correct-${questionId}" value="2" class="correct-answer">
<input type="text" class="answer-text w-full p-3 border rounded-lg text-base bg-white text-gray-900 border-gray-300 focus:ring-2 focus:ring-primary focus:border-primary" placeholder="Answer option 3">
</div>
<div class="flex items-center gap-2">
<input type="radio" name="correct-${questionId}" value="3" class="correct-answer">
<input type="text" class="answer-text w-full p-3 border rounded-lg text-base bg-white text-gray-900 border-gray-300 focus:ring-2 focus:ring-primary focus:border-primary" placeholder="Answer option 4">
</div>
</div>
</div>
</div>
`;

  questionsContainer.insertAdjacentHTML('beforeend', questionHTML);

  // Add event listener for delete button
  const deleteBtn = questionsContainer.querySelector(`#${questionId} .delete-question-btn`);
  if (deleteBtn) {
    deleteBtn.addEventListener('click', function() {
      playClickSound();
      const questionId = this.getAttribute('data-question-id');
      const questionElement = document.getElementById(questionId);
      if (questionElement) {
        questionElement.remove();

        // Check if there are no more questions
        if (questionsContainer.children.length === 0) {
          questionsContainer.innerHTML = `
<div class="text-center text-gray-500 py-8">
No questions added yet. Click "Add Question" to start building your quiz.
</div>
`;
        }
      }
    });
  }
}

// Save the created quiz
function saveQuiz() {
  const quizTitle = document.getElementById('quiz-title').value.trim();
  const quizCategory = document.getElementById('quiz-category').value;
  const questionCards = document.querySelectorAll('.question-card');

  // Validate input
  if (!quizTitle) {
    alert('Please enter a quiz title');
    return;
  }

  if (!quizCategory) {
    alert('Please select a category for your quiz');
    return;
  }

  if (questionCards.length === 0) {
    alert('Please add at least one question to your quiz');
    return;
  }

  // Collect questions
  const questions = [];
  const hints = {};

  for (const card of questionCards) {
    const questionText = card.querySelector('.question-text').value.trim();
    const timeLimit = parseInt(card.querySelector('.time-limit').value);
    const hintText = card.querySelector('.question-hint').value.trim();
    const answerInputs = card.querySelectorAll('.answer-text');
    const correctRadio = card.querySelector('.correct-answer:checked');

    if (!questionText) {
      alert('Please fill in all question texts');
      return;
    }

    const answers = [];
    for (const input of answerInputs) {
      const answerText = input.value.trim();
      if (!answerText) {
        alert('Please fill in all answer options');
        return;
      }
      answers.push(answerText);
    }

    if (!correctRadio) {
      alert('Please select a correct answer for each question');
      return;
    }

    const correct = parseInt(correctRadio.value);

    // Add question
    const questionIndex = questions.length;

    questions.push({
      question: questionText,
      answers: answers,
      correct: correct,
      timeLimit: timeLimit
    });

    // Store hint if provided
    if (hintText) {
      hints[questionIndex] = hintText;
    }
  }

  // Create the quiz object
  const newQuiz = {
    id: 'user_' + Date.now(),
    name: quizTitle,
    category: quizCategory,
    questions: questions,
    hints: hints,
    userCreated: true
  };

  // Add to user quizzes
  userQuizzes.push(newQuiz);

  // Save to localStorage
  saveData('userQuizzes', userQuizzes);

  // Unlock achievement
  unlockAchievement('creator');

  // Show success message with sharing options
  showQuizCreationSuccessModal(newQuiz);
}

// Show success modal with sharing options
function showQuizCreationSuccessModal(quiz) {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
  
  // Create the shareable link
  const shareableLink = createShareableLink(quiz);
  
  modal.innerHTML = `
    <div class="bg-white rounded-lg p-6 max-w-md w-full animate-fade-in-up">
      <div class="text-center mb-6">
        <div class="inline-block p-4 rounded-full bg-green-100 mb-4 text-3xl">✅</div>
        <h2 class="text-2xl font-bold mb-2">Quiz Created!</h2>
        <p class="text-gray-600">${quiz.name} has been created successfully.</p>
      </div>
      
      <div class="share-link-container">
        <p class="share-text">Share this quiz with others:</p>
        <input type="text" class="share-link-input" value="${shareableLink}" readonly>
        <div class="share-actions">
          <button id="copy-link-btn" class="px-4 py-2 bg-blue text-white rounded-lg hover:bg-blue/90 transition-colors">
            <i class="fas fa-copy mr-1"></i> Copy Link
          </button>
          <span id="copy-status" class="text-sm text-green-500 hidden">Copied!</span>
        </div>
      </div>
      
      <div class="mt-6 flex justify-end">
        <button id="close-modal-btn" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
          Close
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Add event listeners
  const copyBtn = document.getElementById('copy-link-btn');
  const closeBtn = document.getElementById('close-modal-btn');
  const copyStatus = document.getElementById('copy-status');
  const linkInput = modal.querySelector('.share-link-input');
  
  if (copyBtn && copyStatus && linkInput) {
    copyBtn.addEventListener('click', () => {
      playClickSound();
      
      // Select the text
      linkInput.select();
      
      // Copy the text
      try {
        // Use clipboard API if available
        navigator.clipboard.writeText(linkInput.value)
          .then(() => {
            // Show success message
            copyStatus.classList.remove('hidden');
            setTimeout(() => {
              copyStatus.classList.add('hidden');
            }, 2000);
          })
          .catch(() => {
            // Fallback - try execCommand
            document.execCommand('copy');
            copyStatus.classList.remove('hidden');
            setTimeout(() => {
              copyStatus.classList.add('hidden');
            }, 2000);
          });
      } catch (err) {
        console.error('Failed to copy link:', err);
      }
    });
  }
  
  if (closeBtn) {
    closeBtn.addEventListener('click', () => {
      playClickSound();
      modal.remove();
      renderMainMenu();
    });
  }
}

// Format game result for display in recent activity
function formatGameResult(quizId) {
  const result = gameState.gameResults[quizId];
  if (!result) return '';
  
  // For standard mode, show points
  if (result.mode === 'standard') {
    return `<div class="badge bg-primary/10 text-primary">
      <i class="fas fa-trophy mr-1"></i>${gameState.highScores[quizId] || 0}
    </div>`;
  }
  
  // For other modes, show a tick or cross
  if (result.result === 'win') {
    return `<div class="badge bg-green/10 text-green">
      <i class="fas fa-check mr-1"></i>Win
    </div>`;
  } else {
    return `<div class="badge bg-red/10 text-red">
      <i class="fas fa-times mr-1"></i>Loss
    </div>`;
  }
}

// Render welcome screen with content
function renderWelcomeScreen() {
  const container = document.getElementById('app-container');
  if (!container) {
    console.error('Container not found');
    return;
  }

  // Create background for welcome screen
  createGameModeBackground('menu');

  // Create avatar selection HTML
  const avatarSelectionHtml = basicAvatars.map(avatar =>
    `<div class="avatar-option flex items-center justify-center text-3xl bg-white shadow-sm" data-avatar-id="${avatar.id}" title="${avatar.name}">
${avatar.emoji}
</div>`
  ).join('');

  // Add premium avatars (but locked if not owned)
  let premiumAvatarHtml = '';
  premiumAvatars.forEach(avatar => {
    const isUnlocked = gameState.unlockedAvatars.includes(avatar.id);
    if (isUnlocked) {
      premiumAvatarHtml += `<div class="avatar-option flex items-center justify-center text-3xl bg-white shadow-sm" data-avatar-id="${avatar.id}" title="${avatar.name}">
      ${avatar.emoji}
      </div>`;
    } else {
      premiumAvatarHtml += `<div class="avatar-option locked flex items-center justify-center text-3xl bg-white shadow-sm" title="${avatar.name} (Locked - ${avatar.price} coins)">
      ${avatar.emoji}
      </div>`;
    }
  });
  
  // Create accessory selection HTML
  let accessorySelectionHtml = '<div class="accessory-option flex items-center justify-center text-lg bg-white shadow-sm selected" data-accessory-id="none" title="No Accessory">❌</div>';
  
  // Add unlocked accessories
  gameState.unlockedAccessories.forEach(accessoryId => {
    const accessory = accessories.find(a => a.id === accessoryId);
    if (accessory) {
      accessorySelectionHtml += `<div class="accessory-option flex items-center justify-center text-lg bg-white shadow-sm" data-accessory-id="${accessory.id}" title="${accessory.name}">
      ${accessory.emoji}
      </div>`;
    }
  });

  // Generate options for official and user-created quizzes
  let quizOptionsHTML = '';

  // Add official quizzes
  quizOptionsHTML += `<optgroup label="Official Quizzes">`;
  quizOptionsHTML += Object.entries(allQuizzes).map(([id, quiz]) =>
    `<option value="${id}">${quiz.name} (${quiz.category})</option>`
  ).join('');
  quizOptionsHTML += `</optgroup>`;

  // Add user-created quizzes if any exist
  if (userQuizzes.length > 0) {
    quizOptionsHTML += `<optgroup label="User-Created Quizzes">`;
    quizOptionsHTML += userQuizzes.map(quiz =>
      `<option value="${quiz.id}">${quiz.name} (${quiz.category})${quiz.isImported ? ' (Imported)' : ''}</option>`
    ).join('');
    quizOptionsHTML += `</optgroup>`;
  }

  // Set inner HTML for the welcome screen with recent activity below Find a Topic
  container.innerHTML = `
<div class="container mx-auto px-4 py-8 max-w-4xl relative z-10">
<div class="flex items-center justify-between mb-6">
<h1 class="text-3xl font-bold text-primary drop-shadow-md">Play Quizzes</h1>
<div class="flex items-center gap-3">
<div class="coin-balance">
<div class="coin-icon">💰</div>
<span id="coin-display">${gameState.coins}</span>
</div>
<button id="back-to-menu-btn" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
<i class="fas fa-home mr-2"></i>Back to Menu
</button>
</div>
</div>

<div class="flex flex-col md:flex-row items-start justify-center gap-6">
<!-- Left Column: User setup -->
<div class="w-full md:w-1/2 order-1 md:order-1">
<div class="content-card bg-white/90 rounded-lg p-6 backdrop-blur mb-8 animate-fade-in">
<div class="mb-6">
<label for="username" class="block text-sm font-medium mb-2">Your Nickname</label>
<input type="text" id="username" class="w-full p-3 border rounded-lg text-base bg-white text-gray-900 border-gray-300 focus:ring-2 focus:ring-primary focus:border-primary" placeholder="Enter your nickname">
</div>

<div class="mb-6">
<label class="block text-sm font-medium mb-3">Choose Your Avatar</label>
<div class="grid grid-cols-5 sm:grid-cols-5 md:grid-cols-5 gap-2 py-2 px-1">
${avatarSelectionHtml}
${premiumAvatarHtml}
</div>
</div>

<div class="mb-6">
<label class="block text-sm font-medium mb-3">Choose Accessory</label>
<div class="flex flex-wrap gap-2 py-2 px-1">
${accessorySelectionHtml}
</div>

<!-- Avatar preview -->
<div class="flex justify-center my-4">
<div id="avatar-preview" class="w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center text-4xl relative">
<!-- Preview will be filled by JS -->
</div>
</div>
</div>

<div class="mb-6">
<label for="quizSelect" class="block text-sm font-medium mb-2">Select Quiz</label>
<select id="quizSelect" class="w-full p-3 border rounded-lg text-base bg-white text-gray-900 border-gray-300 focus:ring-2 focus:ring-primary focus:border-primary">
<option value="">-- Select a Quiz --</option>
${quizOptionsHTML}
</select>
</div>

<!-- Game mode selection -->
<div class="mb-6">
<label class="block text-sm font-medium mb-3">Game Mode</label>
<div class="grid grid-cols-1 gap-2">
<!-- Standard Mode -->
<div class="game-mode-card content-card bg-white/90 rounded-lg p-4 cursor-pointer selected" data-mode-id="standard">
<div class="flex items-center gap-3">
<div class="text-2xl" style="color: #3A9F35">🎯</div>
<div>
<h3 class="font-bold">Standard Quiz</h3>
<p class="text-xs text-gray-600">Classic quiz experience with multiple choice questions</p>
</div>
</div>
</div>
<!-- Boss Fight Mode -->
<div class="game-mode-card content-card bg-white/90 rounded-lg p-4 cursor-pointer" data-mode-id="boss_fight">
<div class="flex items-center gap-3">
<div class="text-2xl" style="color: #e21b3c">⚔️</div>
<div>
<h3 class="font-bold">Boss Fight</h3>
<p class="text-xs text-gray-600">Battle a quiz boss! Each correct answer deals damage</p>
</div>
</div>
</div>
<!-- Sudden Death Mode -->
<div class="game-mode-card content-card bg-white/90 rounded-lg p-4 cursor-pointer" data-mode-id="sudden_death">
<div class="flex items-center gap-3">
<div class="text-2xl" style="color: #E21B3C">❤️</div>
<div>
<h3 class="font-bold">Sudden Death</h3>
<p class="text-xs text-gray-600">One wrong answer and it's game over! How far can you go?</p>
</div>
</div>
</div>
<!-- Team Battle Mode -->
<div class="game-mode-card content-card bg-white/90 rounded-lg p-4 cursor-pointer" data-mode-id="team_battle">
<div class="flex items-center gap-3">
<div class="text-2xl" style="color: #FF8C00">🏆</div>
<div>
<h3 class="font-bold">Team Battle</h3>
<p class="text-xs text-gray-600">Face off against an AI opponent to see who knows more!</p>
</div>
</div>
</div>
</div>
</div>

<button id="start-btn" class="w-full bg-primary hover:bg-primary/90 text-white font-bold py-3 px-4 rounded-lg transition-colors">
<i class="fas fa-play mr-2"></i>Start Game
</button>
</div>
</div>

<!-- Right Column: Topics and Recent activity -->
<div class="w-full md:w-1/2 order-2 md:order-2">
<!-- Topics section -->
<div class="content-card bg-white/90 rounded-lg backdrop-blur mb-8 animate-fade-in">
<div class="p-4 border-b border-gray-200">
<div class="flex justify-between items-center">
<h3 class="text-lg font-bold">Find a Topic</h3>
</div>
<div class="mt-2 relative">
<input type="text" id="search-input" class="w-full p-3 border rounded-lg text-base bg-white text-gray-900 border-gray-300 focus:ring-2 focus:ring-primary focus:border-primary" placeholder="Search for topics...">
<i class="fas fa-search absolute right-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
</div>
</div>
<div id="search-results" class="hidden max-h-60 overflow-y-auto">
<!-- Search results go here -->
</div>
<div id="all-quizzes" class="max-h-60 overflow-y-auto">
<!-- Generated from showAllQuizzes function -->
</div>
</div>

<!-- Recent activity box -->
<div class="content-card bg-white/90 rounded-lg p-4 backdrop-blur mb-8 animate-fade-in">
<div class="flex items-center justify-between mb-3">
<h3 class="text-sm font-medium">
<i class="fas fa-history mr-2"></i>Recent Activity
</h3>
</div>
<div id="recent-activity" class="text-sm mb-4">
${gameState.completedQuizzes.length > 0 ?
gameState.completedQuizzes.slice(-3).map(quizId => {
const quiz = allQuizzes[quizId] || userQuizzes.find(q => q.id === quizId);
return quiz ? `
<div class="recent-activity-item flex justify-between items-center mb-2 p-2 hover:bg-gray-100 rounded cursor-pointer" data-quiz-id="${quizId}">
<div>${quiz.name}</div>
${formatGameResult(quizId)}
</div>
` : '';
}).join('') :
`<div class="text-gray-500 text-center py-2">No quizzes completed yet</div>`
}
</div>
</div>
</div>
</div>
</div>
`;

  // Show all quizzes initially
  showAllQuizzes();

  // Add event listeners
  setupEventListeners();
  
  // Setup avatar preview and accessory selection
  setupAvatarPreview();
}

// Setup avatar preview
function setupAvatarPreview() {
  const avatarOptions = document.querySelectorAll('.avatar-option:not(.locked)');
  const accessoryOptions = document.querySelectorAll('.accessory-option');
  const avatarPreview = document.getElementById('avatar-preview');
  
  if (!avatarPreview) return;
  
  // Make sure at least one avatar is selected
  let selectedAvatar = document.querySelector('.avatar-option.selected');
  if (!selectedAvatar && avatarOptions.length > 0) {
    avatarOptions[0].classList.add('selected');
    selectedAvatar = avatarOptions[0];
  }
  
  // Get initial selected accessory (will be "none" at first)
  let selectedAccessory = document.querySelector('.accessory-option.selected');
  
  // Update preview function
  function updatePreview() {
    if (!selectedAvatar) return;
    
    const avatarEmoji = selectedAvatar.textContent.trim();
    const accessoryId = selectedAccessory && selectedAccessory.getAttribute('data-accessory-id') !== 'none' ? 
                       selectedAccessory.getAttribute('data-accessory-id') : null;
    
    if (accessoryId) {
      const accessory = accessories.find(a => a.id === accessoryId);
      if (accessory) {
        const positionClass = getAccessoryPositionClass(accessoryId);
        avatarPreview.innerHTML = `
          ${avatarEmoji}
          <div class="accessory ${positionClass}">${accessory.emoji}</div>
        `;
      }
    } else {
      avatarPreview.innerHTML = avatarEmoji;
    }
  }
  
  // Initial preview update
  updatePreview();
  
  // Add click handlers for avatars
  avatarOptions.forEach(option => {
    option.addEventListener('click', () => {
      playClickSound();
      // Remove selected class from all options
      avatarOptions.forEach(opt => opt.classList.remove('selected'));
      // Add selected class to clicked option
      option.classList.add('selected');
      selectedAvatar = option;
      // Update preview
      updatePreview();
    });
  });
  
  // Add click handlers for accessories
  accessoryOptions.forEach(option => {
    option.addEventListener('click', () => {
      playClickSound();
      // Remove selected class from all options
      accessoryOptions.forEach(opt => opt.classList.remove('selected'));
      // Add selected class to clicked option
      option.classList.add('selected');
      selectedAccessory = option;
      // Update preview
      updatePreview();
    });
  });
}

// Setup all event listeners for the welcome screen
function setupEventListeners() {
  // Back to menu button
  const backToMenuBtn = document.getElementById('back-to-menu-btn');
  if (backToMenuBtn) {
    backToMenuBtn.addEventListener('click', function() {
      playClickSound();
      renderMainMenu();
    });
  }

  // Start button
  const startBtn = document.getElementById('start-btn');
  if (startBtn) {
    startBtn.addEventListener('click', function() {
      playClickSound();
      handleStartGame();
    });
  } else {
    console.error("Start button not found");
  }

  // Game mode selection
  const gameModeCards = document.querySelectorAll('.game-mode-card');
  if (gameModeCards.length > 0) {
    // Make sure at least the first card has the selected class
    if (!document.querySelector('.game-mode-card.selected')) {
      gameModeCards[0].classList.add('selected');
    }
    
    gameModeCards.forEach(card => {
      card.addEventListener('click', function() {
        playClickSound();
        // Remove selected class from all cards
        gameModeCards.forEach(c => c.classList.remove('selected'));
        // Add selected class to clicked card
        this.classList.add('selected');
        // Update game state
        gameState.gameMode = this.getAttribute('data-mode-id');
        console.log("Game mode selected:", gameState.gameMode);
      });
    });
  } else {
    console.error("Game mode cards not found");
  }

  // Search input
  const searchInput = document.getElementById('search-input');
  if (searchInput) {
    searchInput.addEventListener('input', handleSearch);
  }

  // Add click event listener for recent activity items
  const recentActivityContainer = document.getElementById('recent-activity');
  if (recentActivityContainer) {
    recentActivityContainer.addEventListener('click', function(e) {
      // Find the closest parent activity item
      const activityItem = e.target.closest('.recent-activity-item');
      if (activityItem) {
        playClickSound();
        const quizId = activityItem.getAttribute('data-quiz-id');
        if (quizId) {
          startQuiz(quizId);
        }
      }
    });
  }
}

// Show all quizzes with proper categories
function showAllQuizzes() {
  const allQuizzesEl = document.getElementById('all-quizzes');
  if (!allQuizzesEl) return;

  // Group quizzes by category
  const quizzesByCategory = {};

  // Add official quizzes
  for (const quizId in allQuizzes) {
    const quiz = allQuizzes[quizId];
    const category = quiz.category;

    if (!quizzesByCategory[category]) {
      quizzesByCategory[category] = [];
    }

    quizzesByCategory[category].push({
      id: quizId,
      name: quiz.name,
      isUserCreated: false
    });
  }

  // Add user-created quizzes
  for (const quiz of userQuizzes) {
    const category = quiz.category;

    if (!quizzesByCategory[category]) {
      quizzesByCategory[category] = [];
    }

    quizzesByCategory[category].push({
      id: quiz.id,
      name: quiz.name,
      isUserCreated: true,
      isImported: quiz.isImported
    });
  }

  // Create HTML for categories and quizzes
  let html = '';

  // Sort categories alphabetically
  const sortedCategories = Object.keys(quizzesByCategory).sort();

  for (const category of sortedCategories) {
    html += `
<div class="p-4 bg-primary/5 border-b border-gray-200">
<h4 class="font-bold flex items-center">
<i class="fas fa-folder mr-2 text-primary"></i>${category}
</h4>
</div>
`;

    // Sort quizzes alphabetically within each category
    const sortedQuizzes = quizzesByCategory[category].sort((a, b) =>
      a.name.localeCompare(b.name)
    );

    sortedQuizzes.forEach(quiz => {
      const userCreatedLabel = quiz.isUserCreated ?
        `<span class="badge bg-primary/10 text-primary text-xs">User</span>` : '';
        
      const importedLabel = quiz.isImported ?
        `<span class="badge bg-blue/10 text-blue text-xs ml-1">Imported</span>` : '';

      // Check if this quiz has a high score
      const highScore = gameState.highScores && gameState.highScores[quiz.id];
      const highScoreLabel = highScore ?
        `<span class="badge bg-yellow-100 text-yellow-800 text-xs">
<i class="fas fa-trophy mr-1"></i>${highScore}
</span>` : '';

      html += `
<div class="p-2 py-3 border-b border-gray-200 flex justify-between items-center cursor-pointer hover:bg-primary/5 transition-colors browse-quiz" data-quiz-id="${quiz.id}">
<div>
<div class="font-medium">${quiz.name} ${userCreatedLabel}${importedLabel}</div>
<div class="flex items-center gap-2">
${highScoreLabel}
</div>
</div>
<span class="text-primary">▶</span>
</div>
`;
    });
  }

  // Update the UI
  allQuizzesEl.innerHTML = html;

  // Add click listeners to all quiz items
  const browseQuizzes = document.querySelectorAll('.browse-quiz');
  browseQuizzes.forEach(quiz => {
    quiz.addEventListener('click', function() {
      playClickSound();
      const quizId = this.getAttribute('data-quiz-id');
      startQuiz(quizId);
    });
  });
}

// Handle search input
function handleSearch() {
  const searchInput = document.getElementById('search-input');
  const searchResultsEl = document.getElementById('search-results');
  const allQuizzesEl = document.getElementById('all-quizzes');

  if (!searchInput || !searchResultsEl) return;

  const query = searchInput.value.trim().toLowerCase();

  // Hide all categories when searching
  if (allQuizzesEl) {
    allQuizzesEl.classList.add('hidden');
  }

  // Show all quizzes again if query is empty
  if (query === '') {
    searchResultsEl.classList.add('hidden');
    if (allQuizzesEl) {
      allQuizzesEl.classList.remove('hidden');
    }
    return;
  }

  // Search for matching quizzes
  const results = [];

  // Search official quizzes
  for (const quizId in allQuizzes) {
    const quiz = allQuizzes[quizId];

    if (quiz.name.toLowerCase().includes(query) ||
    quiz.category.toLowerCase().includes(query)) {
      results.push({
        id: quizId,
        name: quiz.name,
        category: quiz.category
      });
    }
  }

  // Search user-created quizzes
  for (const quiz of userQuizzes) {
    if (quiz.name.toLowerCase().includes(query) ||
    quiz.category.toLowerCase().includes(query)) {
      results.push({
        id: quiz.id,
        name: quiz.name,
        category: quiz.category,
        isUserCreated: true,
        isImported: quiz.isImported
      });
    }
  }

  // Display results
  if (results.length > 0) {
    const html = results.map(result => {
      const userCreatedLabel = result.isUserCreated ?
        `<span class="badge bg-primary/10 text-primary text-xs">User</span>` : '';
        
      const importedLabel = result.isImported ?
        `<span class="badge bg-blue/10 text-blue text-xs ml-1">Imported</span>` : '';

      return `
<div class="p-2 py-3 border-b border-gray-200 flex justify-between items-center cursor-pointer hover:bg-primary/5 transition-colors search-result" data-quiz-id="${result.id}">
<div>
<div class="font-medium">${result.name} ${userCreatedLabel}${importedLabel}</div>
<div class="flex items-center gap-2">
<div class="text-xs text-gray-600">${result.category}</div>
</div>
</div>
<span class="text-primary">▶</span>
</div>
`}).join('');

    searchResultsEl.innerHTML = html;
    searchResultsEl.classList.remove('hidden');

    // Add click event listeners
    const searchResults = document.querySelectorAll('.search-result');
    searchResults.forEach(result => {
      result.addEventListener('click', function() {
        playClickSound();
        const quizId = this.getAttribute('data-quiz-id');
        startQuiz(quizId);
      });
    });
  } else {
    searchResultsEl.innerHTML = `
<div class="p-4 text-center text-gray-500">
<i class="fas fa-search mb-2 text-2xl"></i>
<p>No results found for "${query}"</p>
</div>
`;
    searchResultsEl.classList.remove('hidden');
  }
}

// Start a quiz with the given ID
function startQuiz(quizId) {
  // Check if it's an official quiz or user-created quiz
  const quiz = allQuizzes[quizId] || userQuizzes.find(q => q.id === quizId);

  if (!quiz) {
    console.error(`Quiz with ID "${quizId}" not found`);
    return;
  }

  // Set the quiz selection
  const quizSelect = document.getElementById('quizSelect');
  if (quizSelect) {
    quizSelect.value = quizId;
  }

  // Start the game
  handleStartGame();
}

// Handle start game button click
function handleStartGame() {
  const usernameInput = document.getElementById('username');
  const quizSelect = document.getElementById('quizSelect');
  const selectedAvatar = document.querySelector('.avatar-option.selected');
  const selectedAccessory = document.querySelector('.accessory-option.selected');
  const selectedGameMode = document.querySelector('.game-mode-card.selected');

  if (!usernameInput || !quizSelect) {
    console.error("Required form elements not found");
    return;
  }

  // Validate inputs
  const username = usernameInput.value.trim();
  if (!username) {
    alert('Please enter a nickname to start');
    return;
  }

  if (!quizSelect.value) {
    alert('Please select a quiz to start');
    return;
  }

  if (!selectedAvatar) {
    alert('Please select an avatar to start');
    return;
  }

  // Get avatar emoji and id
  const avatarEmoji = selectedAvatar.textContent.trim();
  const avatarId = selectedAvatar.getAttribute('data-avatar-id');
  
  // Get accessory if one is selected
  let accessoryEmoji = null;
  let accessoryId = null;
  
  if (selectedAccessory && selectedAccessory.getAttribute('data-accessory-id') !== 'none') {
    accessoryId = selectedAccessory.getAttribute('data-accessory-id');
    const accessory = accessories.find(a => a.id === accessoryId);
    if (accessory) {
      accessoryEmoji = accessory.emoji;
    }
  }

  // Get selected game mode
  const gameMode = selectedGameMode ? selectedGameMode.getAttribute('data-mode-id') : 'standard';

  // Get the selected quiz (from either official or user-created quizzes)
  const selectedQuizId = quizSelect.value;
  const selectedQuiz = allQuizzes[selectedQuizId] || userQuizzes.find(q => q.id === selectedQuizId);

  if (!selectedQuiz) {
    alert('Selected quiz not found');
    return;
  }

  // Set up game state
  gameState = {
    currentQuiz: selectedQuiz,
    currentQuestionIndex: 0,
    score: 0,
    timer: null,
    timeLeft: 0,
    startTime: 0,
    totalTime: 0,
    correctAnswers: 0,
    playerName: username,
    playerAvatar: avatarEmoji,
    playerAvatarId: avatarId,
    playerAccessory: accessoryEmoji,
    playerAccessoryId: accessoryId,
    quizType: selectedQuizId,
    hintsUsed: 0,
    hintsAvailable: 1, // Maximum 1 hint for any difficulty
    completedQuizzes: gameState.completedQuizzes || [],
    highScores: gameState.highScores || {},
    coins: gameState.coins || 0,
    unlockedAvatars: gameState.unlockedAvatars || basicAvatars.map(a => a.id),
    unlockedAccessories: gameState.unlockedAccessories || [],
    streakCount: 0,
    gameResults: gameState.gameResults || {},
    // Game mode specific
    gameMode: gameMode,
    // Boss Fight specific state
    bossHealth: 0,
    bossMaxHealth: 0,
    currentBoss: null,
    bossAttackInterval: null,
    playerHealth: 100,
    // Sudden Death specific state
    lives: 1,
    // Team Battle specific state
    aiPlayer: null,
    aiScore: 0,
    playerScore: 0
  };

  // Choose a boss if in boss fight mode
  if (gameMode === 'boss_fight') {
    // Select a boss based on quiz length or randomly
    const bossIndex = Math.min(
      Math.floor(Math.random() * bosses.length), 
      bosses.length - 1
    );
    gameState.currentBoss = bosses[bossIndex];
    
    // Set boss health to number of questions in quiz times 10
    gameState.bossHealth = selectedQuiz.questions.length * 10;
    gameState.bossMaxHealth = selectedQuiz.questions.length * 10;
  }
  
  // Select an AI opponent for team battle mode
  if (gameMode === 'team_battle') {
    // Select an AI player that matches the quiz category if possible
    const categoryAIs = aiPlayers.filter(ai => ai.category === selectedQuiz.category);
    
    if (categoryAIs.length > 0) {
      gameState.aiPlayer = categoryAIs[Math.floor(Math.random() * categoryAIs.length)];
    } else {
      // If no matching category, select a random AI
      gameState.aiPlayer = aiPlayers[Math.floor(Math.random() * aiPlayers.length)];
    }
  }
  
  // Change background music based on game mode
  if (isMusicOn) {
    if (gameMode === 'standard') {
      playMusic('standard-music');
    } else if (gameMode === 'boss_fight') {
      playMusic('boss-music');
    } else if (gameMode === 'sudden_death') {
      playMusic('sudden-death-music');
    } else if (gameMode === 'team_battle') {
      playMusic('team-battle-music');
    }
  }

  // Show countdown and then start the game
  startCountdown(() => {
    // Create appropriate background for game mode
    createGameModeBackground(gameMode);
    
    // Render the appropriate game mode
    if (gameMode === 'boss_fight') {
      renderBossFightMode();
    } else if (gameMode === 'sudden_death') {
      renderSuddenDeathMode();
    } else if (gameMode === 'team_battle') {
      renderTeamBattleMode();
    } else {
      renderGameScreen(); // standard mode
    }
  });
}

// Render the Sudden Death game mode
function renderSuddenDeathMode() {
  const container = document.getElementById('app-container');
  if (!container || !gameState.currentQuiz) {
    console.error("Container or quiz not found");
    return;
  }

  const currentQuiz = gameState.currentQuiz;

  container.innerHTML = `
<div class="container mx-auto px-4 py-8 max-w-4xl relative z-10">
<!-- Header with progress and timer -->
<div class="content-card bg-white/90 rounded-lg p-4 mb-6 backdrop-blur">
<div class="flex justify-between items-center mb-4">
<div class="text-sm md:text-base flex items-center">
<span class="mr-2">Question</span>
<span id="current-question" class="bg-primary text-white rounded-full w-8 h-8 flex items-center justify-center">1</span>
<span class="mx-2">/</span>
<span id="total-questions" class="bg-gray-200 rounded-full w-8 h-8 flex items-center justify-center">${currentQuiz.questions.length}</span>
</div>
<div class="text-sm md:text-base font-bold">
<div class="heart-container">
<div class="heart beating-heart">❤️</div>
</div>
</div>
</div>

<!-- Timer Bar -->
<div class="h-2 bg-gray-200 rounded-full overflow-hidden">
<div id="timer-bar" class="h-full bg-red"></div>
</div>
</div>

<!-- Question -->
<div id="question-container" class="mb-8 relative">
<h2 id="question-text" class="text-xl md:text-2xl font-bold mb-6 text-center bg-white/90 rounded-lg p-4 backdrop-blur"></h2>

<!-- Sudden Death indicator -->
<div class="sudden-death-indicator">
<i class="fas fa-heartbeat mr-1"></i>Sudden Death Mode
</div>

<!-- Hint button -->
<div class="flex justify-center mb-4">
  <button id="hint-button" class="hint-button" style="display: none;">
    <i class="fas fa-lightbulb"></i> Use Hint
  </button>
</div>

<!-- Hint content (initially hidden) -->
<div id="hint-content" class="hint-content"></div>

<!-- Answer Grid -->
<div id="answers-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
<!-- Answer cards will be dynamically inserted here -->
</div>
</div>
</div>
`;

  // Add event listener for hint button
  const hintButton = document.getElementById('hint-button');
  const hintContent = document.getElementById('hint-content');
  if (hintButton && hintContent) {
    if (gameState.hintsAvailable > 0) {
      hintButton.style.display = 'inline-flex';
      hintButton.addEventListener('click', () => {
        playHintSound();
        // Get hint for current question
        const hint = getHintForQuestion();
        // Show hint
        hintContent.textContent = hint;
        hintContent.style.display = 'block';
        // Decrement hints available
        gameState.hintsAvailable--;
        gameState.hintsUsed++;
        // Hide hint button
        hintButton.style.display = 'none';
      });
    }
  }

  // Load the first question
  loadQuestion();
}

// Render the Team Battle game mode
function renderTeamBattleMode() {
  const container = document.getElementById('app-container');
  if (!container || !gameState.currentQuiz || !gameState.aiPlayer) {
    console.error("Container, quiz, or AI player not found");
    return;
  }

  const currentQuiz = gameState.currentQuiz;
  const aiPlayer = gameState.aiPlayer;

  // Player avatar with accessory if selected
  const playerAvatarHtml = gameState.playerAccessory ? 
    renderAvatarWithAccessory(gameState.playerAvatar, gameState.playerAccessoryId, 'player-avatar') :
    `<div class="player-avatar">${gameState.playerAvatar}</div>`;

  container.innerHTML = `
<div class="container mx-auto px-4 py-8 max-w-4xl relative z-10">
<!-- Header with progress and timer -->
<div class="content-card bg-white/90 rounded-lg p-4 mb-6 backdrop-blur">
<div class="flex justify-between items-center mb-4">
<div class="text-sm md:text-base flex items-center">
<span class="mr-2">Question</span>
<span id="current-question" class="bg-primary text-white rounded-full w-8 h-8 flex items-center justify-center">1</span>
<span class="mx-2">/</span>
<span id="total-questions" class="bg-gray-200 rounded-full w-8 h-8 flex items-center justify-center">${currentQuiz.questions.length}</span>
</div>
<div class="text-sm md:text-base font-bold">
<span class="bg-orange text-white rounded-full px-3 py-1">TEAM BATTLE</span>
</div>
</div>

<!-- VS Display -->
<div class="vs-container px-4 py-3 mb-3 bg-white/50 rounded-lg">
<div class="player-side">
${playerAvatarHtml}
<div class="player-name">${gameState.playerName}</div>
<div class="player-score" id="player-score">${gameState.playerScore}</div>
</div>
<div class="vs-badge">VS</div>
<div class="ai-side">
<div class="ai-avatar">${aiPlayer.avatar}</div>
<div class="ai-name">${aiPlayer.name}</div>
<div class="ai-score" id="ai-score">${gameState.aiScore}</div>
</div>
</div>

<!-- Timer Bar -->
<div class="h-2 bg-gray-200 rounded-full overflow-hidden">
<div id="timer-bar" class="h-full bg-orange"></div>
</div>
</div>

<!-- Streak indicator (initially hidden) -->
<div id="streak-indicator" class="streak-indicator mb-4 hidden">
<span class="streak-fire flickering">🔥</span>
<span id="streak-count">0</span> Streak
</div>

<!-- Question -->
<div id="question-container" class="mb-8 relative">
<h2 id="question-text" class="text-xl md:text-2xl font-bold mb-6 text-center bg-white/90 p-4 rounded-lg backdrop-blur"></h2>

<!-- Hint button -->
<div class="flex justify-center mb-4">
  <button id="hint-button" class="hint-button" style="display: none;">
    <i class="fas fa-lightbulb"></i> Use Hint
  </button>
</div>

<!-- Hint content (initially hidden) -->
<div id="hint-content" class="hint-content"></div>

<!-- Answer Grid -->
<div id="answers-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
<!-- Answer cards will be dynamically inserted here -->
</div>
</div>
</div>
`;

  // Add event listener for hint button
  const hintButton = document.getElementById('hint-button');
  const hintContent = document.getElementById('hint-content');
  if (hintButton && hintContent) {
    if (gameState.hintsAvailable > 0) {
      hintButton.style.display = 'inline-flex';
      hintButton.addEventListener('click', () => {
        playHintSound();
        // Get hint for current question
        const hint = getHintForQuestion();
        // Show hint
        hintContent.textContent = hint;
        hintContent.style.display = 'block';
        // Decrement hints available
        gameState.hintsAvailable--;
        gameState.hintsUsed++;
        // Hide hint button
        hintButton.style.display = 'none';
      });
    }
  }

  // Load the first question
  loadQuestion();
}

// Render the boss fight game mode
function renderBossFightMode() {
  const container = document.getElementById('app-container');
  if (!container || !gameState.currentQuiz || !gameState.currentBoss) {
    console.error("Container, quiz, or boss not found");
    return;
  }

  const currentQuiz = gameState.currentQuiz;
  const boss = gameState.currentBoss;

  // Player avatar with accessory if selected
  const playerAvatarHtml = gameState.playerAccessory ? 
    renderAvatarWithAccessory(gameState.playerAvatar, gameState.playerAccessoryId, 'player-health-avatar') :
    `<div class="player-health-avatar">${gameState.playerAvatar}</div>`;

  container.innerHTML = `
<div class="container mx-auto px-4 py-8 max-w-4xl relative z-10">
<!-- Header with progress and timer -->
<div class="content-card bg-white/90 rounded-lg p-4 mb-6 backdrop-blur">
<div class="flex justify-between items-center mb-4">
<div class="text-sm md:text-base flex items-center">
<span class="mr-2">Question</span>
<span id="current-question" class="bg-primary text-white rounded-full w-8 h-8 flex items-center justify-center">1</span>
<span class="mx-2">/</span>
<span id="total-questions" class="bg-gray-200 rounded-full w-8 h-8 flex items-center justify-center">${currentQuiz.questions.length}</span>
</div>
<div class="text-sm md:text-base font-bold">
<span class="bg-red text-white rounded-full px-3 py-1">BOSS FIGHT</span>
</div>
</div>

<!-- Player Health with avatar -->
<div class="player-health-info">
  ${playerAvatarHtml}
  <div class="player-health-details">
    <div class="flex justify-between items-center mb-2 text-sm">
      <div>${gameState.playerName}'s Health:</div>
      <div id="health-display" class="font-bold">${gameState.playerHealth}/100</div>
    </div>
    <div class="h-2.5 bg-gray-200 rounded-full overflow-hidden mb-4">
      <div id="player-health-bar" class="h-full bg-green" style="width: ${gameState.playerHealth}%"></div>
    </div>
  </div>
</div>

<!-- Timer Bar -->
<div class="h-2 bg-gray-200 rounded-full overflow-hidden">
<div id="timer-bar" class="h-full bg-primary"></div>
</div>
</div>

<!-- Boss display -->
<div class="boss-container mb-6">
<div class="boss-health-container">
<div id="boss-health" class="boss-health"></div>
</div>
<div class="boss-name">${boss.name}</div>
<div id="boss" class="boss">${boss.emoji}</div>
</div>

<!-- Question -->
<div id="question-container" class="mb-8 relative">
<h2 id="question-text" class="text-xl md:text-2xl font-bold mb-6 text-center bg-white/90 p-4 rounded-lg backdrop-blur"></h2>

<!-- Hint button -->
<div class="flex justify-center mb-4">
  <button id="hint-button" class="hint-button" style="display: none;">
    <i class="fas fa-lightbulb"></i> Use Hint
  </button>
</div>

<!-- Hint content (initially hidden) -->
<div id="hint-content" class="hint-content"></div>

<!-- Answer Grid -->
<div id="answers-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
<!-- Answer cards will be dynamically inserted here -->
</div>
</div>
</div>
`;

  // Add event listener for hint button
  const hintButton = document.getElementById('hint-button');
  const hintContent = document.getElementById('hint-content');
  if (hintButton && hintContent) {
    if (gameState.hintsAvailable > 0) {
      hintButton.style.display = 'inline-flex';
      hintButton.addEventListener('click', () => {
        playHintSound();
        // Get hint for current question
        const hint = getHintForQuestion();
        // Show hint
        hintContent.textContent = hint;
        hintContent.style.display = 'block';
        // Decrement hints available
        gameState.hintsAvailable--;
        gameState.hintsUsed++;
        // Hide hint button
        hintButton.style.display = 'none';
      });
    }
  }

  // Start boss attack interval
  gameState.bossAttackInterval = setInterval(() => {
    bossMakeAttack();
  }, gameState.currentBoss.attackSpeed);

  // Load the first question
  loadQuestion();
}

// Boss makes an attack against the player
function bossMakeAttack() {
  if (gameState.playerHealth <= 0 || gameState.bossHealth <= 0) {
    // Battle is over, stop attacks
    if (gameState.bossAttackInterval) {
      clearInterval(gameState.bossAttackInterval);
      gameState.bossAttackInterval = null;
    }
    return;
  }

  // Get random attack emoji
  const attackEmoji = gameState.currentBoss.attacks[
    Math.floor(Math.random() * gameState.currentBoss.attacks.length)
  ];

  // Create attack visual
  const bossElement = document.getElementById('boss');
  const container = document.querySelector('.boss-container');
  if (bossElement && container) {
    const attack = document.createElement('div');
    attack.className = 'boss-attack';
    attack.textContent = attackEmoji;

    attack.style.left = `${Math.random() * 80 + 10}%`;
    attack.style.bottom = '0';
    container.appendChild(attack);

    // Remove after animation completes
    setTimeout(() => {
      attack.remove();
    }, 1000);
  }

  // Damage player
  gameState.playerHealth = Math.max(0, gameState.playerHealth - gameState.currentBoss.damage);

  // Update health bar
  const playerHealthBar = document.getElementById('player-health-bar');
  const healthDisplay = document.getElementById('health-display');
  
  if (playerHealthBar) {
    playerHealthBar.style.width = `${gameState.playerHealth}%`;

    // Change color based on health
    if (gameState.playerHealth < 30) {
      playerHealthBar.className = 'h-full bg-red';
    } else if (gameState.playerHealth < 60) {
      playerHealthBar.className = 'h-full bg-yellow';
    } else {
      playerHealthBar.className = 'h-full bg-green';
    }
  }
  
  // Update health display text
  if (healthDisplay) {
    healthDisplay.textContent = `${gameState.playerHealth}/100`;
  }

  // Play sound
  playPlayerHitSound();

  // Check if player is defeated
  if (gameState.playerHealth <= 0) {
    // Player defeated
    setTimeout(() => {
      alert("You were defeated by the boss!");
      renderBossFightResults(false);
    }, 500);
  }
}

// Damage the boss
function damageBoss(amount) {
  if (gameState.bossHealth <= 0) return;

  // Reduce boss health
  gameState.bossHealth = Math.max(0, gameState.bossHealth - amount);

  // Update health bar
  const bossHealthBar = document.getElementById('boss-health');
  if (bossHealthBar) {
    bossHealthBar.style.width = `${(gameState.bossHealth / gameState.bossMaxHealth) * 100}%`;
  }

  // Play hit sound
  playBossHitSound();

  // Add visual feedback
  const bossElement = document.getElementById('boss');
  if (bossElement) {
    bossElement.classList.add('boss-hit');
    setTimeout(() => {
      bossElement.classList.remove('boss-hit');
    }, 300);
  }

  // Show damage number
  const container = document.querySelector('.boss-container');
  if (container) {
    const damageText = document.createElement('div');
    damageText.className = 'player-damage';
    damageText.textContent = `-${amount}`;
    damageText.style.left = `${Math.random() * 60 + 20}%`;
    damageText.style.top = `${Math.random() * 40 + 30}%`;
    container.appendChild(damageText);

    // Remove after animation completes
    setTimeout(() => {
      damageText.remove();
    }, 1000);
  }

  // Check if boss is defeated
  if (gameState.bossHealth <= 0) {
    // Boss defeated
    if (gameState.bossAttackInterval) {
      clearInterval(gameState.bossAttackInterval);
      gameState.bossAttackInterval = null;
    }

    // Play defeat animation
    const bossElement = document.getElementById('boss');
    if (bossElement) {
      bossElement.classList.add('boss-defeated');
      playBossDefeatSound();
    }

    // Show victory message and move to results
    setTimeout(() => {
      renderBossFightResults(true);

      // Unlock achievement for defeating a boss
      if (!achievements.find(a => a.id === 'boss_slayer').unlocked) {
        unlockAchievement('boss_slayer');
      }
    }, 2000);
  }
}

// Render the standard game screen
function renderGameScreen() {
  const container = document.getElementById('app-container');
  if (!container || !gameState.currentQuiz) {
    console.error("Container or quiz not found");
    return;
  }

  const currentQuiz = gameState.currentQuiz;

  container.innerHTML = `
<div class="container mx-auto px-4 py-8 max-w-4xl relative z-10">
<!-- Header with progress and timer -->
<div class="content-card bg-white/90 rounded-lg p-4 mb-6 backdrop-blur">
<div class="flex justify-between items-center mb-4">
<div class="text-sm md:text-base flex items-center">
<span class="mr-2">Question</span>
<span id="current-question" class="bg-primary text-white rounded-full w-8 h-8 flex items-center justify-center">1</span>
<span class="mx-2">/</span>
<span id="total-questions" class="bg-gray-200 rounded-full w-8 h-8 flex items-center justify-center">${currentQuiz.questions.length}</span>
</div>
<div class="text-sm md:text-base font-bold flex items-center">
<i class="fas fa-star text-yellow-500 mr-2"></i>
Score: <span id="score" class="ml-1">0</span>
</div>
</div>

<!-- Timer Bar -->
<div class="h-2 bg-gray-200 rounded-full overflow-hidden">
<div id="timer-bar" class="h-full bg-primary"></div>
</div>
</div>

<!-- Question -->
<div id="question-container" class="mb-8 relative">
<h2 id="question-text" class="text-xl md:text-2xl font-bold mb-6 text-center bg-white/90 p-4 rounded-lg backdrop-blur"></h2>

<!-- Hint button -->
<div class="flex justify-center mb-4">
  <button id="hint-button" class="hint-button" style="display: none;">
    <i class="fas fa-lightbulb"></i> Use Hint
  </button>
</div>

<!-- Hint content (initially hidden) -->
<div id="hint-content" class="hint-content"></div>

<!-- Answer Grid -->
<div id="answers-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
<!-- Answer cards will be dynamically inserted here -->
</div>
</div>
</div>
`;

  // Add event listener for hint button
  const hintButton = document.getElementById('hint-button');
  const hintContent = document.getElementById('hint-content');
  if (hintButton && hintContent) {
    if (gameState.hintsAvailable > 0) {
      hintButton.style.display = 'inline-flex';
      hintButton.addEventListener('click', () => {
        playHintSound();
        // Get hint for current question
        const hint = getHintForQuestion();
        // Show hint
        hintContent.textContent = hint;
        hintContent.style.display = 'block';
        // Decrement hints available
        gameState.hintsAvailable--;
        gameState.hintsUsed++;
        // Hide hint button
        hintButton.style.display = 'none';
      });
    }
  }

  // Load the first question
  loadQuestion();
}

// Get hint for current question
function getHintForQuestion() {
  const currentQuiz = gameState.currentQuiz;
  const questionIndex = gameState.currentQuestionIndex;

  // Check if this quiz has custom hints
  if (currentQuiz.hints && currentQuiz.hints[questionIndex]) {
    return currentQuiz.hints[questionIndex];
  }

  // Check if we have predefined hints for this quiz
  const quizId = gameState.quizType;
  if (quizHints[quizId] && quizHints[quizId][questionIndex]) {
    return quizHints[quizId][questionIndex];
  }

  // Fall back to default hints
  return quizHints.default[questionIndex % quizHints.default.length];
}

// Load a question
function loadQuestion() {
  if (!gameState.currentQuiz) return;

  // Clear any existing timer
  if (gameState.timer) {
    clearTimeout(gameState.timer);
  }

  const question = gameState.currentQuiz.questions[gameState.currentQuestionIndex];

  // Update question counter
  const currentQuestionEl = document.getElementById('current-question');
  if (currentQuestionEl) {
    currentQuestionEl.textContent = gameState.currentQuestionIndex + 1;
  }

  // Set question text
  const questionText = document.getElementById('question-text');
  if (questionText) {
    questionText.textContent = question.question;
  }

  // Reset hint content
  const hintContent = document.getElementById('hint-content');
  if (hintContent) {
    hintContent.style.display = 'none';
    hintContent.textContent = '';
  }

  // Show hint button if hints are available
  const hintButton = document.getElementById('hint-button');
  if (hintButton && gameState.hintsAvailable > 0) {
    hintButton.style.display = 'inline-flex';
  }

  // Create answer cards
  const answersGrid = document.getElementById('answers-grid');
  if (answersGrid) {
    // Clear existing answers
    answersGrid.innerHTML = '';

    // Colors for answer cards
    const colors = ['bg-red', 'bg-blue', 'bg-yellow', 'bg-green'];

    // Create new answer buttons
    question.answers.forEach((answer, index) => {
      const button = document.createElement('button');
      button.className = `answer-card ${colors[index]} text-white p-6 rounded-lg text-lg font-semibold h-24 flex items-center justify-center animate-fade-in`;
      button.style.animationDelay = `${index * 0.1}s`;
      button.dataset.index = index;
      button.innerHTML = `<span>${answer}</span>`;

      button.addEventListener('click', (e) => {
        playClickSound();
        handleAnswerClick(e, index);
      });

      answersGrid.appendChild(button);
    });
  }

  // Start timer
  gameState.timeLeft = question.timeLimit;
  gameState.startTime = Date.now();
  startTimer(question.timeLimit);
  
  // For Team Battle mode, simulate AI answering
  if (gameState.gameMode === 'team_battle') {
    simulateAIAnswer();
  }
}

// Simulate AI answering the question
function simulateAIAnswer() {
  if (gameState.gameMode !== 'team_battle') return;
  
  const question = gameState.currentQuiz.questions[gameState.currentQuestionIndex];
  
  // Calculate AI accuracy based on difficulty
  // For now, we'll use a fixed accuracy
  const aiAccuracy = 0.7; // 70% chance of getting it right
  
  // Calculate if AI gets it right
  const isCorrect = Math.random() < aiAccuracy;
  
  // Random answer time between 2 and question time limit
  const aiAnswerTime = Math.random() * (question.timeLimit - 2) + 2;
  
  // Wait that time before showing AI's answer
  setTimeout(() => {
    // If user has already moved to next question, don't show AI result
    if (gameState.currentQuestionIndex !== gameState.currentQuiz.questions.indexOf(question)) {
      return;
    }
    
    if (isCorrect) {
      // AI answered correctly
      gameState.aiScore++;
      const aiScoreEl = document.getElementById('ai-score');
      if (aiScoreEl) {
        aiScoreEl.textContent = gameState.aiScore;
        // Add visual feedback
        aiScoreEl.classList.add('text-green-500');
        setTimeout(() => {
          aiScoreEl.classList.remove('text-green-500');
        }, 1000);
      }
      
      // Visual feedback
      const aiAvatar = document.querySelector('.ai-avatar');
      if (aiAvatar) {
        aiAvatar.classList.add('animate-bounce');
        setTimeout(() => {
          aiAvatar.classList.remove('animate-bounce');
        }, 1000);
      }
    }
  }, aiAnswerTime * 1000);
}

// Start the timer for the current question
function startTimer(duration) {
  const timerBar = document.getElementById('timer-bar');

  if (!timerBar) {
    console.error("Timer bar not found");
    return;
  }

  gameState.timeLeft = duration;

  try {
    // Reset and start animation
    timerBar.style.animation = 'none';
    timerBar.offsetHeight; // Trigger reflow
    timerBar.style.animation = `countdown ${duration}s linear forwards`;
    timerBar.classList.add('timer-animation');

    let intervalId = null;
    
    // Update time remaining counter
    intervalId = setInterval(() => {
      gameState.timeLeft--;

      if (gameState.timeLeft <= 5) {
        // Play tick sound for last 3 seconds
        if (gameState.timeLeft <= 3) {
          playTone(330, 100, 'sine', 0.05);
        }
      }

      if (gameState.timeLeft <= 0) {
        clearInterval(intervalId);
      }
    }, 1000);

    // Set timeout for when time runs out
    gameState.timer = setTimeout(() => {
      if (intervalId) {
        clearInterval(intervalId);
      }
      handleTimeout();
    }, duration * 1000);
  } catch (error) {
    console.error("Error starting timer:", error);
    // Fallback timer without animation
    gameState.timer = setTimeout(() => handleTimeout(), duration * 1000);
  }
}

// Handle timeout (no answer selected)
function handleTimeout() {
  disableAnswers();
  playWrongSound();

  // Reset streak
  gameState.streakCount = 0;
  
  // Update streak indicator if present
  const streakIndicator = document.getElementById('streak-indicator');
  if (streakIndicator) {
    streakIndicator.classList.add('hidden');
  }

  // Show correct answer
  const question = gameState.currentQuiz.questions[gameState.currentQuestionIndex];
  const answerCards = document.querySelectorAll('.answer-card');

  if (answerCards && answerCards.length > question.correct) {
    // Make wrong answers fade
    answerCards.forEach((card, index) => {
      if (index !== question.correct) {
        card.classList.add('opacity-30');
      }
    });

    // Highlight correct answer
    answerCards[question.correct].classList.add('pulse-animation');
    answerCards[question.correct].style.boxShadow = '0 0 15px rgba(58, 159, 53, 0.7)';

    // Handle special game modes
    if (gameState.gameMode === 'boss_fight') {
      // Boss Fight - Take damage when timing out
      const playerHealthBar = document.getElementById('player-health-bar');
      const healthDisplay = document.getElementById('health-display');
      
      if (playerHealthBar) {
        gameState.playerHealth = Math.max(0, gameState.playerHealth - 10);
        playerHealthBar.style.width = `${gameState.playerHealth}%`;

        // Update health display text
        if (healthDisplay) {
          healthDisplay.textContent = `${gameState.playerHealth}/100`;
        }

        // Change color based on health
        if (gameState.playerHealth < 30) {
          playerHealthBar.className = 'h-full bg-red';
        } else if (gameState.playerHealth < 60) {
          playerHealthBar.className = 'h-full bg-yellow';
        } else {
          playerHealthBar.className = 'h-full bg-green';
        }

        playPlayerHitSound();

        // Check if player is defeated
        if (gameState.playerHealth <= 0) {
          if (gameState.bossAttackInterval) {
            clearInterval(gameState.bossAttackInterval);
            gameState.bossAttackInterval = null;
          }
          setTimeout(() => {
            alert("You were defeated by the boss!");
            renderBossFightResults(false);
          }, 1000);
          return;
        }
      }
    } else if (gameState.gameMode === 'sudden_death') {
      // Sudden Death - Game over on time out
      setTimeout(() => {
        alert("Time's up! In Sudden Death Mode, you have to answer within the time limit.");
        renderSuddenDeathResults(false);
      }, 1000);
      return;
    }

    // Wait a moment before loading next question
    setTimeout(() => {
      answerCards[question.correct].classList.remove('pulse-animation');
      nextQuestion();
    }, 2000);
  } else {
    // Fallback if we can't highlight the correct answer
    nextQuestion();
  }
}

// Handle answer click
function handleAnswerClick(e, selectedIndex) {
  // Stop the timer
  clearTimeout(gameState.timer);

  // Calculate time taken
  const timeTaken = (Date.now() - gameState.startTime) / 1000;
  gameState.totalTime += timeTaken;

  // Get question data
  const question = gameState.currentQuiz.questions[gameState.currentQuestionIndex];

  // Disable all answers
  disableAnswers();

  // Get the answer cards
  const answerCards = document.querySelectorAll('.answer-card');

  // Check if answer is correct
  if (selectedIndex === question.correct) {
    // Correct answer
    playCorrectSound();
    
    // Increment streak counter
    gameState.streakCount++;
    
    // Update streak indicator if in Team Battle mode
    if (gameState.gameMode === 'team_battle') {
      const streakIndicator = document.getElementById('streak-indicator');
      if (streakIndicator) {
        const streakCountEl = document.getElementById('streak-count');
        if (streakCountEl) {
          streakCountEl.textContent = gameState.streakCount;
        }
        
        if (gameState.streakCount >= 2) {
          streakIndicator.classList.remove('hidden');
          playStreakSound();
        }
      }
    }

    const timePoints = Math.round((1 - timeTaken / question.timeLimit) * 500);
    const pointsEarned = 500 + Math.max(0, timePoints);

    gameState.score += pointsEarned;
    gameState.correctAnswers++;
    
    // For Team Battle, update player score
    if (gameState.gameMode === 'team_battle') {
      gameState.playerScore++;
      const playerScoreEl = document.getElementById('player-score');
      if (playerScoreEl) {
        playerScoreEl.textContent = gameState.playerScore;
        // Add visual feedback
        playerScoreEl.classList.add('text-green-500');
        setTimeout(() => {
          playerScoreEl.classList.remove('text-green-500');
        }, 1000);
      }
    }

    // Handle special game mode logic
    if (gameState.gameMode === 'boss_fight') {
      // Updated boss damage calculation based on time left
      const baseDamage = 10;
      // Calculate bonus damage based on time left relative to total time
      const timeLeftRatio = gameState.timeLeft / question.timeLimit;
      const totalDamage = Math.floor(baseDamage + (timeLeftRatio * 20));

      // Damage the boss
      damageBoss(totalDamage);

      // If boss was defeated, don't continue with normal flow
      if (gameState.bossHealth <= 0) {
        return;
      }
    }

    // Update score display for non-boss/team battle modes
    if (gameState.gameMode !== 'boss_fight' && gameState.gameMode !== 'team_battle') {
      const scoreEl = document.getElementById('score');
      if (scoreEl) {
        scoreEl.textContent = gameState.score;

        // Animate score increase
        scoreEl.classList.add('text-green-500', 'scale-125');
        setTimeout(() => {
          scoreEl.classList.remove('text-green-500', 'scale-125');
        }, 1000);
      }

      // Show points earned notification
      const pointsNotification = document.createElement('div');
      pointsNotification.className = 'absolute top-0 right-0 bg-green-500 text-white px-3 py-1 rounded-full font-bold animate-fade-in';
      pointsNotification.textContent = `+${pointsEarned}`;
      e.target.appendChild(pointsNotification);
    }

    // Visual feedback for correct answer
    e.target.classList.add('pulse-animation');
    e.target.style.boxShadow = '0 0 15px rgba(58, 159, 53, 0.7)';

    // Make other answers fade
    answerCards.forEach((card, index) => {
      if (index !== selectedIndex) {
        card.classList.add('opacity-30');
      }
    });

    // Wait a moment before loading next question
    setTimeout(() => {
      e.target.classList.remove('pulse-animation');
      nextQuestion();
    }, 1500);
  } else {
    // Incorrect answer
    playWrongSound();
    
    // Reset streak
    gameState.streakCount = 0;
    
    // Update streak indicator if present
    const streakIndicator = document.getElementById('streak-indicator');
    if (streakIndicator) {
      streakIndicator.classList.add('hidden');
    }

    // Add wrong answer visual feedback
    e.target.classList.add('opacity-30');
    e.target.style.boxShadow = '0 0 15px rgba(226, 27, 60, 0.7)';

    // Handle game mode specific logic for wrong answers
    if (gameState.gameMode === 'boss_fight') {
      // Boss Fight - Take extra damage for wrong answer
      const playerHealthBar = document.getElementById('player-health-bar');
      const healthDisplay = document.getElementById('health-display');
      
      if (playerHealthBar) {
        gameState.playerHealth = Math.max(0, gameState.playerHealth - 15);
        playerHealthBar.style.width = `${gameState.playerHealth}%`;
        
        // Update health display text
        if (healthDisplay) {
          healthDisplay.textContent = `${gameState.playerHealth}/100`;
        }

        // Change color based on health
        if (gameState.playerHealth < 30) {
          playerHealthBar.className = 'h-full bg-red';
        } else if (gameState.playerHealth < 60) {
          playerHealthBar.className = 'h-full bg-yellow';
        } else {
          playerHealthBar.className = 'h-full bg-green';
        }

        playPlayerHitSound();

        // Check if player is defeated
        if (gameState.playerHealth <= 0) {
          if (gameState.bossAttackInterval) {
            clearInterval(gameState.bossAttackInterval);
            gameState.bossAttackInterval = null;
          }
          setTimeout(() => {
            alert("You were defeated by the boss!");
            renderBossFightResults(false);
          }, 1000);
          return;
        }
      }
    } else if (gameState.gameMode === 'sudden_death') {
      // Sudden Death - Game over on first wrong answer
      playLifeLostSound();
      
      setTimeout(() => {
        renderSuddenDeathResults(false);
      }, 1500);
      
      // Show correct answer first
      if (answerCards && answerCards.length > question.correct) {
        // Highlight correct answer
        answerCards[question.correct].classList.add('pulse-animation');
        answerCards[question.correct].style.boxShadow = '0 0 15px rgba(58, 159, 53, 0.7)';
      }
      
      return;
    }

    // Show which answer was correct
    if (answerCards && answerCards.length > question.correct) {
      // Make other wrong answers fade
      answerCards.forEach((card, index) => {
        if (index !== question.correct && index !== selectedIndex) {
          card.classList.add('opacity-30');
        }
      });

      // Highlight correct answer
      answerCards[question.correct].classList.add('pulse-animation');
      answerCards[question.correct].style.boxShadow = '0 0 15px rgba(58, 159, 53, 0.7)';

      // Wait a moment before loading next question
      setTimeout(() => {
        answerCards[question.correct].classList.remove('pulse-animation');
        nextQuestion();
      }, 2000);
    } else {
      // Fallback if we can't highlight the correct answer
      nextQuestion();
    }
  }
}

// Disable all answer buttons
function disableAnswers() {
  const answerCards = document.querySelectorAll('.answer-card');
  answerCards.forEach(card => {
    card.disabled = true;
    card.classList.add('cursor-not-allowed');
  });

  // Stop timer animation
  const timerBar = document.getElementById('timer-bar');
  if (timerBar) {
    timerBar.style.animationPlayState = 'paused';
  }

  // Disable hint button
  const hintButton = document.getElementById('hint-button');
  if (hintButton) {
    hintButton.style.display = 'none';
  }
}

// Move to the next question or end the quiz
function nextQuestion() {
  gameState.currentQuestionIndex++;

  if (gameState.currentQuestionIndex >= gameState.currentQuiz.questions.length) {
    // End of quiz
    if (gameState.gameMode === 'standard') {
      renderResultsScreen();
    } else if (gameState.gameMode === 'boss_fight') {
      // Boss fight mode
      // If the boss is already defeated, we don't need to show the results again
      if (gameState.bossHealth > 0) {
        // Boss wasn't defeated, player survived to the end
        renderBossFightResults(true);
      }
    } else if (gameState.gameMode === 'sudden_death') {
      renderSuddenDeathResults(true);
    } else if (gameState.gameMode === 'team_battle') {
      renderTeamBattleResults();
    }
  } else {
    // Load next question
    loadQuestion();
  }
}

// Render Sudden Death results screen
function renderSuddenDeathResults(survived) {
  const container = document.getElementById('app-container');
  if (!container) return;

  const currentQuiz = gameState.currentQuiz;

  // Add quiz to completed list if not already there
  if (!gameState.completedQuizzes.includes(gameState.quizType)) {
    gameState.completedQuizzes.push(gameState.quizType);
  }

  // Save game result
  gameState.gameResults[gameState.quizType] = {
    mode: 'sudden_death',
    result: survived ? 'win' : 'loss'
  };

  // Calculate coin reward
  let coinsEarned = gameState.correctAnswers;
  
  // Bonus for surviving
  const survivalBonus = survived ? 1 : 0;
  const totalCoins = coinsEarned + survivalBonus;

  // Update total coins
  gameState.coins += totalCoins;

  // Save stats to localStorage
  saveData('stats', {
    completedQuizzes: gameState.completedQuizzes,
    highScores: gameState.highScores,
    coins: gameState.coins,
    gameResults: gameState.gameResults
  });

  // Check achievements
  checkAchievements({
    correctAnswers: gameState.correctAnswers,
    totalQuestions: currentQuiz.questions.length,
    totalTime: gameState.totalTime
  });

  // Sudden Death Challenge achievement
  if (survived && !achievements.find(a => a.id === 'sudden_death_challenge').unlocked) {
    unlockAchievement('sudden_death_challenge');
  }
  
  // Change back to menu music
  if (isMusicOn) {
    playMusic('menu-music');
  }
  
  // Set background back to jungle pattern
  createGameModeBackground('menu');

  // Player avatar with accessory if selected
  const playerAvatarHtml = gameState.playerAccessory ? 
    renderAvatarWithAccessory(gameState.playerAvatar, gameState.playerAccessoryId, 'w-16 h-16 mx-auto mb-2 flex items-center justify-center text-3xl relative') :
    `<div class="w-16 h-16 mx-auto mb-2 flex items-center justify-center text-3xl">${gameState.playerAvatar}</div>`;

  container.innerHTML = `
<div class="container mx-auto px-4 py-8 max-w-4xl relative z-10">
<div class="flex flex-col items-center justify-center">
<div class="content-card bg-white/90 rounded-lg p-6 backdrop-blur mb-8 w-full max-w-md animate-fade-in">
<div class="text-center mb-4">
${playerAvatarHtml}
<div class="inline-block p-4 rounded-full ${survived ? 'bg-primary/10' : 'bg-red/10'} mb-2 text-3xl">${survived ? '🏆' : '💔'}</div>
<h2 class="text-3xl font-bold mb-2">${survived ? 'Perfect Survivor!' : 'So Close!'}</h2>
<p class="text-gray-600">${survived ? 'You answered all questions correctly in Sudden Death Mode!' : `You made it through ${gameState.correctAnswers} questions in Sudden Death Mode!`}</p>
</div>

<div class="flex justify-between items-center p-3 bg-yellow-100 rounded-lg animate-fade-in" style="animation-delay: 0.3s">
<div class="flex items-center">
<div class="coin-icon text-lg mr-2">💰</div>
<div>
<div class="font-bold">Coins Earned</div>
<div class="text-sm">${coinsEarned} correct + ${survivalBonus} ${survivalBonus > 0 ? 'survival bonus' : ''}</div>
</div>
</div>
<div class="text-2xl font-bold text-yellow-600">+${totalCoins}</div>
</div>
</div>

<div class="w-full max-w-md mb-8 content-card bg-white/90 rounded-lg p-6 backdrop-blur animate-fade-in" style="animation-delay: 0.1s">
<h3 class="font-bold text-lg mb-4 flex items-center">
<i class="fas fa-chart-bar text-red mr-2"></i>Your Results
</h3>
<div class="space-y-4">
<div class="flex justify-between items-center">
<span>Questions Answered:</span>
<span id="correct-answers" class="text-lg font-bold">${gameState.correctAnswers}/${currentQuiz.questions.length}</span>
</div>
<div class="w-full bg-gray-200 rounded-full h-2.5">
<div class="bg-primary h-2.5 rounded-full" style="width: ${Math.round((gameState.correctAnswers / currentQuiz.questions.length) * 100)}%"></div>
</div>
<div class="flex justify-between items-center">
<span>Average Time:</span>
<span id="avg-time" class="text-lg font-bold">${gameState.correctAnswers > 0 ? Math.round((gameState.totalTime / gameState.correctAnswers) * 10) / 10 : 0}s</span>
</div>
<div class="flex justify-between items-center">
<span>Hints Used:</span>
<span id="hints-used" class="text-lg font-bold">${gameState.hintsUsed}</span>
</div>
<div class="flex justify-between items-center">
<span>Total Coins:</span>
<span class="text-lg font-bold text-yellow-600">${gameState.coins}</span>
</div>
</div>
</div>

<div class="flex flex-wrap gap-4 justify-center animate-fade-in" style="animation-delay: 0.3s">
<button id="play-again-btn" class="bg-primary hover:bg-primary/90 text-white font-bold py-3 px-6 rounded-lg transition-colors mb-8">
<i class="fas fa-redo mr-2"></i>Try Another Quiz
</button>

<button id="shop-btn" class="bg-secondary hover:bg-secondary/90 text-white font-bold py-3 px-6 rounded-lg transition-colors mb-8">
<i class="fas fa-store mr-2"></i>Visit Shop
</button>

<button id="back-to-menu-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition-colors mb-8">
<i class="fas fa-home mr-2"></i>Back to Menu
</button>
</div>
</div>
</div>
`;

  // Launch confetti if survived
  if (survived) {
    setTimeout(() => {
      launchConfetti();
      playCoinSound();
    }, 500);
  }

  // Add event listeners
  const playAgainBtn = document.getElementById('play-again-btn');
  const shopBtn = document.getElementById('shop-btn');
  const backToMenuBtn = document.getElementById('back-to-menu-btn');

  if (playAgainBtn) {
    playAgainBtn.addEventListener('click', () => {
      playClickSound();
      renderWelcomeScreen();
    });
  }

  if (shopBtn) {
    shopBtn.addEventListener('click', () => {
      playClickSound();
      renderShopScreen();
    });
  }

  if (backToMenuBtn) {
    backToMenuBtn.addEventListener('click', () => {
      playClickSound();
      renderMainMenu();
    });
  }
}

// Render Team Battle results screen
function renderTeamBattleResults() {
  const container = document.getElementById('app-container');
  if (!container) return;

  const currentQuiz = gameState.currentQuiz;
  const aiPlayer = gameState.aiPlayer;

  // Determine winner
  const playerWon = gameState.playerScore > gameState.aiScore;
  const tie = gameState.playerScore === gameState.aiScore;
  
  // Add quiz to completed list if not already there
  if (!gameState.completedQuizzes.includes(gameState.quizType)) {
    gameState.completedQuizzes.push(gameState.quizType);
  }

  // Save game result
  gameState.gameResults[gameState.quizType] = {
    mode: 'team_battle',
    result: playerWon ? 'win' : (tie ? 'tie' : 'loss')
  };
  
  // Calculate coin reward
  let coinsEarned = gameState.correctAnswers;
  
  // Bonus for winning
  const victoryBonus = playerWon ? 1 : 0;
  const totalCoins = coinsEarned + victoryBonus;

  // Update total coins
  gameState.coins += totalCoins;

  // Save stats to localStorage
  saveData('stats', {
    completedQuizzes: gameState.completedQuizzes,
    highScores: gameState.highScores,
    coins: gameState.coins,
    gameResults: gameState.gameResults
  });

  // Check achievements
  checkAchievements({
    correctAnswers: gameState.correctAnswers,
    totalQuestions: currentQuiz.questions.length,
    totalTime: gameState.totalTime
  });

  // Team Champion achievement
  if (playerWon && !achievements.find(a => a.id === 'team_champion').unlocked) {
    unlockAchievement('team_champion');
  }
  
  // Change back to menu music
  if (isMusicOn) {
    playMusic('menu-music');
  }
  
  // Set background back to jungle pattern
  createGameModeBackground('menu');

  // Player avatar with accessory if selected
  const playerAvatarHtml = gameState.playerAccessory ? 
    renderAvatarWithAccessory(gameState.playerAvatar, gameState.playerAccessoryId, 'player-avatar') :
    `<div class="player-avatar">${gameState.playerAvatar}</div>`;

  container.innerHTML = `
<div class="container mx-auto px-4 py-8 max-w-4xl relative z-10">
<div class="flex flex-col items-center justify-center">
<div class="content-card bg-white/90 rounded-lg p-6 backdrop-blur mb-8 w-full max-w-md animate-fade-in">
<div class="text-center mb-4">
<div class="inline-block p-4 rounded-full ${playerWon ? 'bg-primary/10' : tie ? 'bg-blue/10' : 'bg-red/10'} mb-2 text-3xl">${playerWon ? '🏆' : tie ? '🤝' : '😢'}</div>
<h2 class="text-3xl font-bold mb-2">${playerWon ? 'Victory!' : tie ? 'It\'s a Tie!' : 'Defeated!'}</h2>
<p class="text-gray-600">${playerWon ? `You defeated ${aiPlayer.name}!` : tie ? 'Both of you answered the same number of questions correctly!' : `${aiPlayer.name} won this round.`}</p>
</div>

<div class="vs-container px-6 py-5 mb-5 bg-orange/5 rounded-lg">
<div class="player-side">
${playerAvatarHtml}
<div class="player-name font-bold">${gameState.playerName}</div>
<div class="player-score text-3xl font-bold ${playerWon ? 'text-primary' : ''}">${gameState.playerScore}</div>
</div>
<div class="vs-badge">VS</div>
<div class="ai-side">
<div class="ai-avatar">${aiPlayer.avatar}</div>
<div class="ai-name font-bold">${aiPlayer.name}</div>
<div class="ai-score text-3xl font-bold ${!playerWon && !tie ? 'text-primary' : ''}">${gameState.aiScore}</div>
</div>
</div>

<div class="flex justify-between items-center p-3 bg-yellow-100 rounded-lg animate-fade-in" style="animation-delay: 0.3s">
<div class="flex items-center">
<div class="coin-icon text-lg mr-2">💰</div>
<div>
<div class="font-bold">Coins Earned</div>
<div class="text-sm">${coinsEarned} correct + ${victoryBonus} ${victoryBonus > 0 ? 'victory bonus' : ''}</div>
</div>
</div>
<div class="text-2xl font-bold text-yellow-600">+${totalCoins}</div>
</div>
</div>

<div class="w-full max-w-md mb-8 content-card bg-white/90 rounded-lg p-6 backdrop-blur animate-fade-in" style="animation-delay: 0.1s">
<h3 class="font-bold text-lg mb-4 flex items-center">
<i class="fas fa-chart-bar text-orange mr-2"></i>Your Results
</h3>
<div class="space-y-4">
<div class="flex justify-between items-center">
<span>Correct Answers:</span>
<span id="correct-answers" class="text-lg font-bold">${gameState.correctAnswers}/${currentQuiz.questions.length}</span>
</div>
<div class="w-full bg-gray-200 rounded-full h-2.5">
<div class="bg-primary h-2.5 rounded-full" style="width: ${Math.round((gameState.correctAnswers / currentQuiz.questions.length) * 100)}%"></div>
</div>
<div class="flex justify-between items-center">
<span>Average Time:</span>
<span id="avg-time" class="text-lg font-bold">${Math.round((gameState.totalTime / currentQuiz.questions.length) * 10) / 10}s</span>
</div>
<div class="flex justify-between items-center">
<span>Hints Used:</span>
<span id="hints-used" class="text-lg font-bold">${gameState.hintsUsed}</span>
</div>
<div class="flex justify-between items-center">
<span>Total Coins:</span>
<span class="text-lg font-bold text-yellow-600">${gameState.coins}</span>
</div>
</div>
</div>

<div class="flex flex-wrap gap-4 justify-center animate-fade-in" style="animation-delay: 0.3s">
<button id="play-again-btn" class="bg-primary hover:bg-primary/90 text-white font-bold py-3 px-6 rounded-lg transition-colors mb-8">
<i class="fas fa-redo mr-2"></i>Try Another Quiz
</button>

<button id="shop-btn" class="bg-secondary hover:bg-secondary/90 text-white font-bold py-3 px-6 rounded-lg transition-colors mb-8">
<i class="fas fa-store mr-2"></i>Visit Shop
</button>

<button id="back-to-menu-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition-colors mb-8">
<i class="fas fa-home mr-2"></i>Back to Menu
</button>
</div>
</div>
</div>
`;

  // Launch confetti if player won
  if (playerWon) {
    setTimeout(() => {
      launchConfetti();
      playCoinSound();
    }, 500);
  }

  // Add event listeners
  const playAgainBtn = document.getElementById('play-again-btn');
  const shopBtn = document.getElementById('shop-btn');
  const backToMenuBtn = document.getElementById('back-to-menu-btn');

  if (playAgainBtn) {
    playAgainBtn.addEventListener('click', () => {
      playClickSound();
      renderWelcomeScreen();
    });
  }

  if (shopBtn) {
    shopBtn.addEventListener('click', () => {
      playClickSound();
      renderShopScreen();
    });
  }

  if (backToMenuBtn) {
    backToMenuBtn.addEventListener('click', () => {
      playClickSound();
      renderMainMenu();
    });
  }
}

// Render Boss Fight results screen
function renderBossFightResults(playerWon) {
  // Clear attack interval if still active
  if (gameState.bossAttackInterval) {
    clearInterval(gameState.bossAttackInterval);
    gameState.bossAttackInterval = null;
  }

  const container = document.getElementById('app-container');
  if (!container) return;

  // Add quiz to completed list if not already there
  if (!gameState.completedQuizzes.includes(gameState.quizType)) {
    gameState.completedQuizzes.push(gameState.quizType);
  }

  // Save game result
  gameState.gameResults[gameState.quizType] = {
    mode: 'boss_fight',
    result: playerWon ? 'win' : 'loss'
  };

  // Calculate coin reward
  let coinsEarned = gameState.correctAnswers;
  if (playerWon) {
    // Bonus coins for winning
    coinsEarned += 1;
  }

  // Update total coins
  gameState.coins += coinsEarned;

  // Save stats to localStorage
  saveData('stats', {
    completedQuizzes: gameState.completedQuizzes,
    highScores: gameState.highScores,
    coins: gameState.coins,
    gameResults: gameState.gameResults
  });

  // Check achievements
  checkAchievements({
    correctAnswers: gameState.correctAnswers,
    totalQuestions: gameState.currentQuiz.questions.length,
    totalTime: gameState.totalTime
  });

  // Coin collector achievement check
  if (gameState.coins >= 100 && !achievements.find(a => a.id === 'coin_collector').unlocked) {
    unlockAchievement('coin_collector');
  }
  
  // Change back to menu music
  if (isMusicOn) {
    playMusic('menu-music');
  }
  
  // Set background back to jungle pattern
  createGameModeBackground('menu');

  // Defeat message
  let resultTitle = playerWon ? "Victory!" : "Defeated!";
  let resultMessage = playerWon 
    ? `You defeated the ${gameState.currentBoss.name}!` 
    : `You were defeated by the ${gameState.currentBoss.name}. Better luck next time!`;

  // Player avatar with accessory if selected
  const playerAvatarHtml = gameState.playerAccessory ? 
    renderAvatarWithAccessory(gameState.playerAvatar, gameState.playerAccessoryId, 'player-health-avatar') :
    `<div class="player-health-avatar">${gameState.playerAvatar}</div>`;

  container.innerHTML = `
<div class="container mx-auto px-4 py-8 max-w-4xl relative z-10">
<div class="flex flex-col items-center justify-center">
<div class="content-card bg-white/90 rounded-lg p-6 backdrop-blur mb-8 w-full max-w-md animate-fade-in">
<div class="text-center mb-4">
<div class="inline-block p-4 rounded-full bg-${playerWon ? 'primary' : 'red'}/10 mb-2 text-3xl">${playerWon ? '🏆' : '☠️'}</div>
<h2 class="text-3xl font-bold mb-2">${resultTitle}</h2>
<p class="text-gray-600">${resultMessage}</p>
</div>

<div class="text-lg text-center font-bold mb-2">
Battle Results
</div>

<div class="mb-6">
<div class="player-health-info mb-4">
  ${playerAvatarHtml}
  <div class="player-health-details">
    <div class="flex justify-between items-center mb-2 text-sm">
      <div>${gameState.playerName}'s Health:</div>
      <span>${gameState.playerHealth}/100</span>
    </div>
    <div class="h-3 bg-gray-200 rounded-full overflow-hidden">
      <div class="${gameState.playerHealth < 30 ? 'bg-red' : gameState.playerHealth < 60 ? 'bg-yellow' : 'bg-green'} h-full" style="width: ${gameState.playerHealth}%"></div>
    </div>
  </div>
</div>

<div class="flex justify-between items-center mb-3">
<span>Boss Health:</span>
<span>${gameState.bossHealth}/${gameState.bossMaxHealth}</span>
</div>
<div class="h-3 bg-gray-200 rounded-full overflow-hidden">
<div class="bg-red h-full" style="width: ${(gameState.bossHealth / gameState.bossMaxHealth) * 100}%"></div>
</div>
</div>

<div class="flex justify-between items-center p-3 bg-yellow-100 rounded-lg animate-fade-in" style="animation-delay: 0.3s">
<div class="flex items-center">
<div class="coin-icon text-lg mr-2">💰</div>
<div>
<div class="font-bold">Coins Earned</div>
<div class="text-sm">${gameState.correctAnswers} correct + ${playerWon ? '1 victory bonus' : '0'}</div>
</div>
</div>
<div class="text-2xl font-bold text-yellow-600">+${coinsEarned}</div>
</div>
</div>

<div class="w-full max-w-md mb-8 content-card bg-white/90 rounded-lg p-6 backdrop-blur animate-fade-in" style="animation-delay: 0.1s">
<h3 class="font-bold text-lg mb-4 flex items-center">
<i class="fas fa-chart-bar text-primary mr-2"></i>Your Results
</h3>
<div class="space-y-4">
<div class="flex justify-between items-center">
<span>Correct Answers:</span>
<span id="correct-answers" class="text-lg font-bold">${gameState.correctAnswers}/${gameState.currentQuiz.questions.length}</span>
</div>
<div class="w-full bg-gray-200 rounded-full h-2.5">
<div class="bg-primary h-2.5 rounded-full" style="width: ${Math.round((gameState.correctAnswers / gameState.currentQuiz.questions.length) * 100)}%"></div>
</div>
<div class="flex justify-between items-center">
<span>Accuracy:</span>
<span id="accuracy" class="text-lg font-bold">${Math.round((gameState.correctAnswers / gameState.currentQuiz.questions.length) * 100)}%</span>
</div>
<div class="flex justify-between items-center">
<span>Average Time:</span>
<span id="avg-time" class="text-lg font-bold">${Math.round((gameState.totalTime / gameState.currentQuiz.questions.length) * 10) / 10}s</span>
</div>
<div class="flex justify-between items-center">
<span>Total Coins:</span>
<span class="text-lg font-bold text-yellow-600">${gameState.coins}</span>
</div>
</div>
</div>

<div class="flex flex-wrap gap-4 justify-center animate-fade-in" style="animation-delay: 0.3s">
<button id="play-again-btn" class="bg-primary hover:bg-primary/90 text-white font-bold py-3 px-6 rounded-lg transition-colors mb-8">
<i class="fas fa-redo mr-2"></i>Try Another Quiz
</button>

<button id="shop-btn" class="bg-secondary hover:bg-secondary/90 text-white font-bold py-3 px-6 rounded-lg transition-colors mb-8">
<i class="fas fa-store mr-2"></i>Visit Shop
</button>

<button id="back-to-menu-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition-colors mb-8">
<i class="fas fa-home mr-2"></i>Back to Menu
</button>
</div>
</div>
</div>
`;

  // Launch confetti for victory
  if (playerWon) {
    setTimeout(() => {
      launchConfetti();
    }, 500);
  }

  // Add event listeners
  const playAgainBtn = document.getElementById('play-again-btn');
  const shopBtn = document.getElementById('shop-btn');
  const backToMenuBtn = document.getElementById('back-to-menu-btn');

  if (playAgainBtn) {
    playAgainBtn.addEventListener('click', () => {
      playClickSound();
      renderWelcomeScreen();
    });
  }

  if (shopBtn) {
    shopBtn.addEventListener('click', () => {
      playClickSound();
      renderShopScreen();
    });
  }

  if (backToMenuBtn) {
    backToMenuBtn.addEventListener('click', () => {
      playClickSound();
      renderMainMenu();
    });
  }
}

// Render the standard mode results screen
function renderResultsScreen() {
  const container = document.getElementById('app-container');
  if (!container) return;

  const currentQuiz = gameState.currentQuiz;

  // Add quiz to completed list if not already there
  if (!gameState.completedQuizzes.includes(gameState.quizType)) {
    gameState.completedQuizzes.push(gameState.quizType);
  }

  // Update high score if better than previous
  const previousHighScore = gameState.highScores[gameState.quizType] || 0;
  if (gameState.score > previousHighScore) {
    gameState.highScores[gameState.quizType] = gameState.score;
  }

  // Save game result
  gameState.gameResults[gameState.quizType] = {
    mode: 'standard',
    result: 'complete'
  };

  // Calculate coin reward (1 coin per correct answer)
  const coinsEarned = gameState.correctAnswers;

  // Bonus coins for perfect score
  const perfectBonus = gameState.correctAnswers === currentQuiz.questions.length ? 1 : 0;
  const totalCoins = coinsEarned + perfectBonus;

  // Update total coins
  gameState.coins += totalCoins;

  // Save stats to localStorage
  saveData('stats', {
    completedQuizzes: gameState.completedQuizzes,
    highScores: gameState.highScores,
    coins: gameState.coins,
    gameResults: gameState.gameResults
  });

  // Check for achievements
  checkAchievements({
    correctAnswers: gameState.correctAnswers,
    totalQuestions: currentQuiz.questions.length,
    totalTime: gameState.totalTime
  });

  // Coin collector achievement check
  if (gameState.coins >= 100 && !achievements.find(a => a.id === 'coin_collector').unlocked) {
    unlockAchievement('coin_collector');
  }
  
  // Change back to menu music
  if (isMusicOn) {
    playMusic('menu-music');
  }
  
  // Set background back to jungle pattern
  createGameModeBackground('menu');

  // Calculate performance metrics
  const accuracy = Math.round((gameState.correctAnswers / currentQuiz.questions.length) * 100);
  const avgTime = Math.round((gameState.totalTime / currentQuiz.questions.length) * 10) / 10;

  // Determine performance message
  let performanceMessage = '';
  if (accuracy === 100) {
    performanceMessage = "Perfect score! You're a quiz master!";
  } else if (accuracy >= 80) {
    performanceMessage = "Great job! You really know your stuff!";
  } else if (accuracy >= 60) {
    performanceMessage = "Good effort! Keep practicing!";
  } else if (accuracy >= 40) {
    performanceMessage = "Not bad! Try again to improve your score.";
  } else {
    performanceMessage = "Keep learning and try again soon!";
  }

  // Player avatar with accessory if selected
  const playerAvatarHtml = gameState.playerAccessory ? 
    renderAvatarWithAccessory(gameState.playerAvatar, gameState.playerAccessoryId, 'w-16 h-16 mx-auto mb-2 flex items-center justify-center text-3xl relative') :
    `<div class="w-16 h-16 mx-auto mb-2 flex items-center justify-center text-3xl">${gameState.playerAvatar}</div>`;

  container.innerHTML = `
<div class="container mx-auto px-4 py-8 max-w-4xl relative z-10">
<div class="flex flex-col items-center justify-center">
<div class="content-card bg-white/90 rounded-lg p-6 backdrop-blur mb-8 w-full max-w-md animate-fade-in">
<div class="text-center mb-4">
${playerAvatarHtml}
<div class="inline-block p-4 rounded-full bg-primary/10 mb-2 text-3xl">🎉</div>
<h2 class="text-3xl font-bold mb-2">Quiz Complete!</h2>
<p class="text-gray-600">${performanceMessage}</p>
</div>

<div class="text-xl mb-6 text-center">
Final Score: <span id="final-score" class="font-bold text-primary text-2xl">${gameState.score}</span>
</div>

<div class="flex justify-between items-center p-3 bg-yellow-100 rounded-lg animate-fade-in" style="animation-delay: 0.3s">
<div class="flex items-center">
<div class="coin-icon text-lg mr-2">💰</div>
<div>
<div class="font-bold">Coins Earned</div>
<div class="text-sm">${coinsEarned} correct + ${perfectBonus} ${perfectBonus > 0 ? 'perfect bonus' : ''}</div>
</div>
</div>
<div class="text-2xl font-bold text-yellow-600">+${totalCoins}</div>
</div>
</div>

<div class="w-full max-w-md mb-8 content-card bg-white/90 rounded-lg p-6 backdrop-blur animate-fade-in" style="animation-delay: 0.1s">
<h3 class="font-bold text-lg mb-4 flex items-center">
<i class="fas fa-chart-bar text-primary mr-2"></i>Your Results
</h3>
<div class="space-y-4">
<div class="flex justify-between items-center">
<span>Correct Answers:</span>
<span id="correct-answers" class="text-lg font-bold">${gameState.correctAnswers}/${currentQuiz.questions.length}</span>
</div>
<div class="w-full bg-gray-200 rounded-full h-2.5">
<div class="bg-primary h-2.5 rounded-full" style="width: ${accuracy}%"></div>
</div>
<div class="flex justify-between items-center">
<span>Accuracy:</span>
<span id="accuracy" class="text-lg font-bold">${accuracy}%</span>
</div>
<div class="flex justify-between items-center">
<span>Average Time:</span>
<span id="avg-time" class="text-lg font-bold">${avgTime}s</span>
</div>
<div class="flex justify-between items-center">
<span>Hints Used:</span>
<span id="hints-used" class="text-lg font-bold">${gameState.hintsUsed}</span>
</div>
<div class="flex justify-between items-center">
<span>Total Coins:</span>
<span class="text-lg font-bold text-yellow-600">${gameState.coins}</span>
</div>
</div>
</div>

<div class="flex flex-wrap gap-4 justify-center animate-fade-in" style="animation-delay: 0.3s">
<button id="play-again-btn" class="bg-primary hover:bg-primary/90 text-white font-bold py-3 px-6 rounded-lg transition-colors mb-8">
<i class="fas fa-redo mr-2"></i>Try Another Quiz
</button>

<button id="shop-btn" class="bg-secondary hover:bg-secondary/90 text-white font-bold py-3 px-6 rounded-lg transition-colors mb-8">
<i class="fas fa-store mr-2"></i>Visit Shop
</button>

<button id="back-to-menu-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition-colors mb-8">
<i class="fas fa-home mr-2"></i>Back to Menu
</button>
</div>
</div>
</div>
`;

  // Launch confetti
  setTimeout(() => {
    launchConfetti();
    playCoinSound();
  }, 500);

  // Add event listeners
  const playAgainBtn = document.getElementById('play-again-btn');
  const shopBtn = document.getElementById('shop-btn');
  const backToMenuBtn = document.getElementById('back-to-menu-btn');

  if (playAgainBtn) {
    playAgainBtn.addEventListener('click', () => {
      playClickSound();
      renderWelcomeScreen();
    });
  }

  if (shopBtn) {
    shopBtn.addEventListener('click', () => {
      playClickSound();
      renderShopScreen();
    });
  }

  if (backToMenuBtn) {
    backToMenuBtn.addEventListener('click', () => {
      playClickSound();
      renderMainMenu();
    });
  }
}

// Initialize the application
document.addEventListener('DOMContentLoaded', function() {
  try {
    console.log('DOM content loaded, initializing app...');
    // Load saved data first
    loadSavedData();
    // Setup sound
    setupSoundControl();
    // Start playing menu music if music is enabled
    if (isMusicOn) {
      playMusic('menu-music');
    }
    // Render main menu
    renderMainMenu();
  } catch (error) {
    console.error("Error initializing app:", error);
    // Fallback content if there's an error
    const container = document.getElementById('app-container');
    if (container) {
      container.innerHTML = `
<div class="container mx-auto px-4 py-8 max-w-4xl">
<div class="bg-white rounded-lg p-6 shadow-lg">
<h1 class="text-3xl font-bold mb-4 text-primary">Quizzer</h1>
<p class="mb-4">There was an error loading the application. Please refresh the page to try again.</p>
<button onclick="location.reload()" class="bg-primary text-white px-4 py-2 rounded-lg">
Refresh Page
</button>
</div>
</div>
`;
    }
  }
});
</script>
</body>
</html>